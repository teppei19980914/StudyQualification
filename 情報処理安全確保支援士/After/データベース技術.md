# リレーショナルデータベースの設計・制約・分散処理の体系整理

## はじめに

2025年10月のプロジェクトマネージャ試験受験を終え、2026年秋の情報処理安全確保支援士に向けて勉強中です。
本記事を含めた各知識のインデックスや学習の道のりについては、「[情報処理安全確保支援士への道のり(随時更新中)](https://qiita.com/teppei19980914/items/a25279a17b210d6ed9f4)」をご参照ください。
**本記事は学習した内容を記載しています。**

## 該当問題

[情報セキュリティスペシャリスト平成22年秋期 午前Ⅱ 問21](https://www.sc-siken.com/kakomon/22_aki/am2_21.html)
[情報セキュリティスペシャリスト平成24年春期 午前Ⅱ 問21](https://www.sc-siken.com/kakomon/24_haru/am2_21.html)
[情報セキュリティスペシャリスト平成25年秋期 午前Ⅱ 問21](https://www.sc-siken.com/kakomon/25_aki/am2_21.html)
[情報セキュリティスペシャリスト平成26年春期 午前Ⅱ 問21](https://www.sc-siken.com/kakomon/26_haru/am2_21.html)
[情報セキュリティスペシャリスト平成27年春期 午前Ⅱ 問21](https://www.sc-siken.com/kakomon/27_haru/am2_21.html)
[情報処理安全確保支援士令和3年秋期 午前Ⅱ 問21](https://www.sc-siken.com/kakomon/03_aki/am2_21.html)

## 関係モデル

データを行(タプル)と列(属性)からなる関係(Relation)で表現するデータモデルで、現在のRDB(Relational Database)の基礎となっています。

## SQL における制約(Constraint)とは

制約とは **データの正確性/一貫性/整合性を保証するためのルール** であり、ACID特性のうち「一貫性(Consistency)」を担保する重要な仕組みです。

## NOT NULL 制約

### 意味

列に **NULL が入ることを禁止**します。

### 例

```sql
CREATE TABLE users (
    user_id INT PRIMARY KEY,
    name    VARCHAR(50) NOT NULL
);
```

### 特徴

- INSERT/UPDATE で NULL を入れるとエラー
- 空文字列 ("") と NULL は別扱い

## CHECK 制約

### 意味

列の値が **指定した条件を満たす場合のみ許可** します。

### 例

```sql
CREATE TABLE employees (
    emp_id INT PRIMARY KEY,
    age    INT CHECK(age BETWEEN 0 AND 150),
    grade  CHAR(1) CHECK(grade IN ('A','B','C'))
);
```

### 特徴

- 条件違反時はエラー
- RDBMS によりサポート差あり(MySQL 8.0 未満は無視)

## UNIQUE 制約(重複禁止)

### 意味

列、または列の組が **重複してはいけません**。

### 例

```sql
CREATE TABLE accounts (
    account_id INT PRIMARY KEY,
    email      VARCHAR(255) UNIQUE
);
```

複数列のユニークも可能です。

```sql
UNIQUE (room_id, reserved_day)
```

### 特徴

- NULL は複数許可(SQL標準)
- 多くのDBで自動的にインデックス作成

## PRIMARY KEY 制約(主キー)

### 意味

行を一意に識別するキーです。

#### 主キーの性質

- NOT NULL
- UNIQUE
- 1表に1つだけ定義可能

### 例

```sql
CREATE TABLE products (
    product_id INT PRIMARY KEY,
    name       VARCHAR(50)
);
```

複合主キーの例です。

```sql
PRIMARY KEY(student_id, subject_id)
```

## FOREIGN KEY 制約(参照整合性制約)

### 意味

他表の **主キーまたは UNIQUE 列** を参照し、整合性を保証します。

### 例

```sql
CREATE TABLE customers (
    customer_id INT PRIMARY KEY
);

CREATE TABLE orders (
    order_id    INT PRIMARY KEY,
    customer_id INT,
    FOREIGN KEY (customer_id)
        REFERENCES customers(customer_id)
);
```

### 参照整合性の保持

* 参照元には参照先に存在しない値を挿入できない
* 参照先の行が削除されたら、参照元の整合性を保つための動作が必要

## 外部キーの参照アクション(ON DELETE/ON UPDATE)

| アクション | 動作 |
|-----------|------|
| NO ACTION | 不整合があれば拒否 |
| RESTRICT  | 参照されていれば削除/更新不可 |
| CASCADE   | 親の削除/更新を子へ伝播 |
| SET NULL  | 親削除時に子を NULL |
| SET DEFAULT | 既定値を設定 |

例：

```sql
FOREIGN KEY(customer_id)
  REFERENCES customers(customer_id)
  ON DELETE CASCADE
  ON UPDATE CASCADE;
```

## ALTER TABLE による制約追加/削除

### 追加

```sql
ALTER TABLE users
  ADD CONSTRAINT email_unique UNIQUE(email);
```

### 削除

```sql
ALTER TABLE users
  DROP CONSTRAINT email_unique;
```

## 正規化

データの重複や不整合を防ぐため、表を段階的に構造化する手法です。正規化により**更新時異常（挿入異常・更新異常・削除異常）**を防止します。

### 関数従属性（Functional Dependency）

属性Xの値が決まると属性Yの値が一意に決まる関係を **X → Y** と表記し、「YはXに関数従属する」と言います。

| 用語 | 説明 |
|---|---|
| 完全関数従属 | 主キー全体に従属（主キーの一部では決まらない） |
| 部分関数従属 | 主キーの一部に従属 |
| 推移的関数従属 | X → Y → Z のように間接的に従属 |

### 正規化の段階

#### 非正規形

繰り返し項目（繰り返し属性）が含まれている状態です。

#### 第1正規形（1NF）

第1正規形では、下記2点を実施します。

* 繰り返し属性を排除
* すべての属性が原子値（分割不可能な値）となるように分割

#### 第2正規形（2NF）

第2正規形では、下記1点を実施します。

* **部分関数従属を排除**（すべての非キー属性が主キー全体に完全関数従属）

#### 第3正規形（3NF）

第3正規形では、下記1点を実施します。

* **推移的関数従属を排除**（非キー属性間の従属関係を排除）

#### ボイス-コッド正規形（BCNF）

* すべての関数従属 X → Y において、Xが候補キーである
* 第3正規形をさらに厳密にした形態
* 候補キーが複数ある場合に第3正規形との差異が出る

### 正規化の段階と排除対象の整理

| 正規形 | 排除対象 | 条件 |
|---|---|---|
| 第1正規形 | 繰り返し属性 | すべて原子値 |
| 第2正規形 | 部分関数従属 | 完全関数従属のみ |
| 第3正規形 | 推移的関数従属 | 非キー間の従属なし |
| BCNF | 候補キー以外からの関数従属 | すべての決定項が候補キー |

## ACID特性

データベースのトランザクション処理が持つべき4つの性質のことです。

|特性|意味|
|:----|:----|
|Atomicity(原子性)|全部成功 or 全部失敗|
|Consistency(一貫性)|制約を常に満たす|
|Isolation(独立性)|他トランザクションの影響を受けない|
|Durability(永続性)|コミット後は永続保存|

## トランザクション管理とリカバリ

### WAL（Write Ahead Logging）

**更新データをディスクに書き込む前に、必ずログを先に書き込む**という原則です。障害発生時にログを用いてデータの復旧を可能にします。

### ログの種類

| ログ | 用途 |
|---|---|
| UNDOログ | 未コミットの変更を取り消す（ロールバック用） |
| REDOログ | コミット済みの変更を再適用する（ロールフォワード用） |

### チェックポイント（Checkpoint）

メモリ上の更新内容をディスクに強制書き出しするタイミングです。チェックポイントにより、リカバリ時にログを遡る範囲を限定し、**復旧時間を短縮**できます。

### リカバリの種類

| 方式 | 説明 | 使用ログ |
|---|---|---|
| ロールバック（Rollback） | 未コミットのトランザクションを取り消す | UNDOログ |
| ロールフォワード（Roll Forward） | コミット済みだがディスク未反映のトランザクションを再適用 | REDOログ |

#### 障害発生時のリカバリ手順

1. チェックポイント以降のログを読み込む
2. コミット済みトランザクション → **ロールフォワード**（REDO）
3. 未コミットトランザクション → **ロールバック**（UNDO）

### 障害の分類

| 障害 | 説明 | 復旧方法 |
|---|---|---|
| トランザクション障害 | プログラムのエラー等 | ロールバック |
| システム障害 | OS停止、電源断等 | UNDO/REDOによるリカバリ |
| メディア障害 | ディスク故障等 | バックアップ＋ログによるリカバリ |

## ロックと分離レベル

### ロックの種類

ロックには下記2つがあります。

* **共有ロック（Shared Lock / S Lock）**：読み取り時に取得。他トランザクションの読み取りは許可するが、書き込みは拒否する
* **排他ロック（Exclusive Lock / X Lock）**：書き込み時に取得。他トランザクションの読み取り・書き込みをともに拒否する

#### ロック互換マトリクス

| | 共有ロック要求 | 排他ロック要求 |
|---|---|---|
| 共有ロック保持中 | ○（許可） | ×（待機） |
| 排他ロック保持中 | ×（待機） | ×（待機） |

### ロックの粒度

| 粒度 | 対象 | 特徴 |
|---|---|---|
| 行ロック | 1行単位 | 同時実行性が高いがオーバヘッド大 |
| ページロック | ページ（ブロック）単位 | 行とテーブルの中間 |
| テーブルロック | テーブル全体 | オーバヘッド小だが同時実行性が低い |

### 楽観的ロックと悲観的ロック

| 方式 | 説明 | 用途 |
|---|---|---|
| 悲観的ロック（Pessimistic） | データ読み取り時にロック取得。競合を事前に防止 | 更新頻度が高い業務 |
| 楽観的ロック（Optimistic） | ロックせずに読み取り、更新時にバージョン番号やタイムスタンプで競合検出 | 読み取り中心の業務、Webアプリケーション |

### デッドロック（Deadlock）

2つ以上のトランザクションが、互いに相手のロック解放を待ち続けて処理が進まなくなる状態です。

#### デッドロックの例

1. トランザクションAがテーブルXに排他ロック
2. トランザクションBがテーブルYに排他ロック
3. トランザクションAがテーブルYのロックを要求 → 待機
4. トランザクションBがテーブルXのロックを要求 → 待機（デッドロック発生）

#### デッドロックの検出と対策

| 対策 | 説明 |
|---|---|
| タイムアウト | 一定時間後にトランザクションを強制中断 |
| デッドロック検出（Wait-for Graph） | 待ちグラフで循環を検出し、一方をロールバック |
| ロック順序の統一 | テーブルへのアクセス順序を統一して予防 |
| ロック保持時間の短縮 | トランザクションを短く保つ |

### 分離レベルとトランザクション異常

#### トランザクション異常の種類

| 異常現象 | 説明 |
|---|---|
| ダーティリード（Dirty Read） | 他トランザクションの未コミットデータを読み取る |
| ノンリピータブルリード（Non-Repeatable Read） | 同じ行を再読み取りすると値が変わっている |
| ファントムリード（Phantom Read） | 同じ条件で再検索すると行数が増減している |

#### 分離レベルと異常の対応表

| 分離レベル | ダーティリード | ノンリピータブルリード | ファントムリード |
|---|---|---|---|
| READ UNCOMMITTED | 発生する | 発生する | 発生する |
| READ COMMITTED | **防止** | 発生する | 発生する |
| REPEATABLE READ | **防止** | **防止** | 発生する |
| SERIALIZABLE | **防止** | **防止** | **防止** |

※ 分離レベルが高いほど整合性は向上するが、同時実行性能は低下する（トレードオフ）

## 関係演算(Relational Algebra)の体系整理

関係演算は **関係データベースの理論的基盤**であり、SQL の構文の多くは関係演算を基に設計されています。

### 基本演算(5つ)

#### 選択(Selection：σ)

行を条件で絞り込む演算です。
SQL の **WHERE** に対応しています。

例(年齢>=20 の社員)：

```
σ age >= 20 (Employees)
```

#### 射影(Projection：π)

列を抽出する演算です。
SQL の **SELECT 列名** に対応します。

例：

```
π name, age (Employees)
```

#### 直積(Cartesian Product：×)

2つの関係をすべての組み合わせで結合します。
SQL の **CROSS JOIN** に対応しています。

#### 和(Union：∪)

2つの関係の和集合(重複削除)です。
SQL の **UNION** に対応します。

#### 差(Difference：−)

片方にしか存在しない行を取得します。
SQL の **EXCEPT/MINUS** に対応します。

### 派生演算(応用演算)

#### 共通(Intersection：∩)

共通する行を抽出します。
SQL の **INTERSECT** に対応します。

#### 結合(Join)

SQL JOIN の原型です。
自然結合/等値結合などが含まれます。

例：

```
Employees ⋈ Employees.dept_id = Departments.dept_id Departments
```

#### 商(Division：÷)

「すべての条件を満たす行」を求める演算です。
SQL に直接の構文はなく、NOT EXISTS や HAVING COUNT で表現します。

## SQL の4大命令(DML)

### SELECT(検索)

```sql
SELECT name, age FROM employees WHERE age >= 20;
```

### INSERT(追加)

```sql
INSERT INTO employees (id, name, age) VALUES (1, 'Taro', 30);
```

### UPDATE(更新)

```sql
UPDATE employees SET age = age + 1 WHERE id = 1;
```

### DELETE(削除)

```sql
DELETE FROM employees WHERE id = 1;
```

## SQL の周辺知識

### JOIN の種類

- INNER JOIN
- LEFT/RIGHT OUTER JOIN
- FULL OUTER JOIN

### GROUP BY と HAVING

集約後の条件は HAVING です。

### ビュー(VIEW)

複雑なクエリを仮想表として再利用します。

### インデックス

検索性能改善(B+tree/Hash)に使用します。

### GRANT文

#### 何を付与するか（Privilege）

表・ビュー等のDBオブジェクトに対する権限（例：SELECT/INSERT/UPDATE/DELETE等）を主体（ユーザ・ロール等）に付与します。

#### 誰に付与するか（User / Role / PUBLIC）

多くのDBでは「ユーザ」「ロール（役割）」「PUBLIC（全員に相当する集合）」に付与できます。
ただし、**PUBLICは"全権付与"ではありません**。単に「対象集合が広い」だけです（付与される権限の種類・範囲はGRANT句で明示したものに限定されます）。

#### WITH GRANT OPTION（付与権）の意味

##### 何が起きるか

`WITH GRANT OPTION` を付けると、**受領者は「その権限をさらに他者へGRANTできる」**ようになります。
逆に言えば、これが無い場合は「自分は使えるが、他人へ配れない」です。

##### リスク

付与権は"権限の拡散"を招きやすいので、運用上は最小権限の観点から慎重に扱います。

##### REVOKEとの関係（CASCADEが絡む典型論点）

付与権で連鎖的に権限が配られた後に取り消すと、**連鎖（依存関係）**が発生します。
例えばSQL Serverの説明では、GRANT OPTIONで与えられた権限を取り消す際にCASCADEを付けないと失敗し得る旨が示されています。
製品差はありますが、「付与権は撤回が難しくなり得る」という実務的ポイントは共通理解として重要です。

### ビューと権限

- ビューは「表のように見せる論理オブジェクト」であり、参照権限（SELECT）の付与対象になり得ます
- ただし、ビューの定義や実装によっては、基表権限や所有者権限（definer/invokerの扱い）など追加論点が出ます

### ER 図と外部キー

- 1対多は外部キーで表現
- 多対多は中間テーブル(交差テーブル)を用います

## データベースセキュリティ

情報処理安全確保支援士試験において、データベースセキュリティは**午前II・午後問題ともに頻出**の重要テーマです。

### SQLインジェクション対策

SQLインジェクションとは、Webアプリケーション等の入力値にSQL文を混入させ、意図しないSQL文を実行させる攻撃です。

#### 攻撃の例

```sql
-- ログイン画面で以下を入力
ユーザ名: ' OR '1'='1' --
-- 生成されるSQL
SELECT * FROM users WHERE name = '' OR '1'='1' --' AND password = '...'
-- WHERE条件が常にTRUEとなり、全ユーザ情報が取得される
```

#### 対策手法

| 対策 | 説明 | 効果 |
|---|---|---|
| **バインド機構（プレースホルダ）** | SQL文のパラメータ部分を ? や :name で置き換え、値を別途バインド | **最も効果的**。SQL構文とデータを分離 |
| エスケープ処理 | シングルクォート等の特殊文字をエスケープ | バインド機構が使えない場合の補助的手段 |
| 入力値検証（バリデーション） | 許可する文字種・桁数を制限 | 多層防御の一環 |
| WAF（Web Application Firewall） | 既知の攻撃パターンを検出・遮断 | 多層防御の一環 |
| 最小権限の原則 | アプリケーション用DBユーザの権限を最小化 | 被害範囲の限定 |
| エラーメッセージの制御 | DB内部エラーをユーザに表示しない | 情報漏洩の防止 |

#### バインド機構（プリペアドステートメント）の例

```sql
-- 静的プレースホルダ（推奨）
PREPARE stmt FROM 'SELECT * FROM users WHERE name = ? AND password = ?';
EXECUTE stmt USING @name, @password;
```

※ **静的プレースホルダ**はDBMS側でSQL構文を事前解析するため、原理的にSQLインジェクションが発生しない

### データベースの暗号化

| 方式 | 説明 |
|---|---|
| **TDE（Transparent Data Encryption）** | DBMS がデータファイル全体を透過的に暗号化。アプリケーション変更不要 |
| 列レベル暗号化 | 特定の列（クレジットカード番号等）のみを暗号化 |
| 通信経路の暗号化 | DB接続にSSL/TLSを使用し、通信を暗号化 |

### データベースの監査（Audit）

データベースに対する操作を記録し、不正アクセスや情報漏洩の検出・追跡を行います。

| 監査項目 | 記録内容 |
|---|---|
| ログイン監査 | 誰が、いつ、どこから接続したか |
| DML監査 | SELECT/INSERT/UPDATE/DELETEの実行記録 |
| DDL監査 | CREATE/ALTER/DROPの実行記録 |
| 権限変更監査 | GRANT/REVOKEの実行記録 |

### アクセス制御

| 方式 | 説明 |
|---|---|
| ロールベースアクセス制御（RBAC） | ロール（役割）に権限を割り当て、ユーザにロールを付与 |
| 行レベルセキュリティ（RLS） | ユーザごとにアクセス可能な行を制限（例：自部署のデータのみ参照可） |
| 列レベルセキュリティ | 特定の列へのアクセスを制限 |
| ビューによるアクセス制御 | ビューを通じて限定的なデータのみ公開 |

### REVOKE文（権限の取り消し）

```sql
REVOKE SELECT ON employees FROM user_a;
REVOKE ALL PRIVILEGES ON employees FROM user_b CASCADE;
```

| 構文 | 説明 |
|---|---|
| REVOKE 権限 ON 対象 FROM ユーザ | 指定した権限を取り消す |
| CASCADE | WITH GRANT OPTIONで連鎖的に付与された権限も含めて取り消す |
| RESTRICT | 連鎖的な取り消しが発生する場合はエラーとする |

### データマスキング

| 方式 | 説明 |
|---|---|
| 静的マスキング | データのコピーを作成し、コピー上で不可逆にマスク。テスト環境向け |
| 動的マスキング | 実データは変更せず、クエリ結果を動的にマスクして返却。本番環境向け |

### データベースセキュリティの多層防御

```
[アプリケーション層] 入力値検証 / バインド機構 / エスケープ
        ↓
[ネットワーク層]    ファイアウォール / WAF / SSL/TLS通信
        ↓
[データベース層]    最小権限 / RBAC / 監査ログ / 暗号化
        ↓
[ストレージ層]      TDE / バックアップ暗号化
```

## 分散データベースシステムとは

分散データベースシステム(Distributed Database System)とは、物理的に異なる複数のコンピュータに配置されたデータベースを、論理的には一つのデータベースとして利用できるようにしたシステムです。
C.J. Date や ISO/IEC による定義では、分散データベースの本質は次の点にあります。

- データは複数拠点に分散配置されている
- 利用者やアプリケーションからは単一のデータベースとして見える
- 分散による複雑さは DBMS が吸収する

**この「分散を意識させない」ための性質を 透過性(Transparency) と呼びます。**

## 透過性(Transparency)の基本概念

透過性とは、分散によって生じる内部構造/配置/制御の違いを、利用者に意識させない性質を指します。
分散データベースシステムの評価軸は、「どれだけ多くの透過性を実現できているか」に集約されます。

### 分割に対する透過性(Fragmentation Transparency)

分割に対する透過性とは、データが分割されて格納されていることを、利用者が意識せずに利用できる性質です。
分割には次の代表例があります。

- 水平分割(行単位で分割)
- 垂直分割(列単位で分割)

利用者は通常の SQL 文を用いるだけでよく、どの分割片を参照しているかを意識する必要はありません。

### 位置に対する透過性(Location Transparency)

位置に対する透過性とは、データがどの物理的拠点に存在するかを、利用者が意識しなくてよい性質のことです。
分散データベースにおいて、最も基本的な透過性の一つです。

### 移動に対する透過性(Migration Transparency)

移動に対する透過性とは、データが拠点間で移動しても、アプリケーションを変更せずに利用できる性質です。
位置透過性が「現在どこにあるか」を隠すのに対し、移動透過性は「場所が変わること自体」を隠す点が異なります。

### 複製に対する透過性(Replication Transparency)

複製に対する透過性とは、データが複数コピー(レプリカ)されていることを利用者に意識させない性質です。
この透過性により、以下が実現されます。

- 可用性の向上(障害時の代替)
- 読み取り性能の向上

レプリカ間の整合性や同期処理は DBMS が管理し、利用者は単一のデータとして扱えます。

### 障害に対する透過性(Failure Transparency)

障害に対する透過性とは、一部のノードや通信に障害が発生しても、利用者にその影響を感じさせない性質のことです。
重要なのは、**障害が起きないこと**ではなく**障害が起きても見せないこと**です。

### データモデルに対する透過性(Data Model Transparency)

データモデルに対する透過性とは、内部で使用されているデータモデルの違いを、利用者に意識させない性質です。
異種システム統合やレガシー移行で重要となります。

### 透過性の整理(試験向け一覧)

| 透過性 | 隠す対象 |
|---|---|
| 分割に対する透過性 | 分割方法 |
| 位置に対する透過性 | 存在場所 |
| 移動に対する透過性 | 移動 |
| 複製に対する透過性 | コピーの存在 |
| 障害に対する透過性 | 障害の影響 |
| データモデルに対する透過性 | 内部構造 |

## 2相コミットプロトコル(Two-Phase Commit Protocol, 2PC)

### 定義(エビデンス：Gray & Reuter, Transaction Processing/ISO/IEC)

**2相コミットプロトコル(2PC)**とは、**分散トランザクションにおいて、複数の参加ノード(参加者)がすべて同じ判断(コミット or アボート)を行うことを保証するためのコミット制御プロトコル**です。
目的は、**分散環境でも「トランザクションの原子性」を保証すること**です。

## 分散トランザクションと課題

### 単一DBとの違い

| 単一データベース | 分散データベース |
|---|---|
| ローカルログで制御可能 | 複数ノードの協調が必要 |
| 障害範囲が限定 | ネットワーク障害が発生 |
| COMMITは一箇所 | COMMIT判断を揃える必要 |

→ **「一部だけ更新される」状態が最も危険**です。

## 2相コミットの基本構造

### 登場人物

| 役割 | 説明 |
|---|---|
| コーディネータ(Coordinator) | トランザクション全体を管理 |
| 参加者(Participant) | 各データベース／ノード |

## 2相コミットの処理手順(最重要)

### 第1相：準備フェーズ(Prepare Phase)

1. コーディネータが各参加者に **「コミット可能か？」** を問い合わせ
2. 各参加者は以下を実施
   - 更新内容をログに書き込み(Undo/Redoログ)
   - ロックを保持したまま
   - **Yes(準備完了) or No(不可)** を返信

→ この時点では **まだ確定していない**

### 第2相：確定フェーズ(Commit Phase)

#### 全参加者が Yes の場合

1. コーディネータが **COMMIT 指示**
2. 各参加者がコミット実行
3. ロック解放

#### 1つでも No があった場合

1. コーディネータが **ABORT(ROLLBACK)指示**
2. 各参加者がロールバック
3. ロック解放

→ **全体で必ず同じ結果になります**

## 2相コミットが保証する性質

| 特性               | 2PCでの扱い  |
| ---------------- | -------- |
| 原子性(Atomicity)   | ◎ 保証     |
| 一貫性(Consistency) | DB側制約に依存 |
| 独立性(Isolation)   | ロックにより保証 |
| 永続性(Durability)  | ログにより保証  |

**中でも原子性を担保する仕組みです。**

## 障害発生時の挙動

### 参加者障害

* 再起動後、ログを参照
* コミット済／未確定を判断可能

### コーディネータ障害

* 参加者は 「コミットかアボートか分からない状態」 になる
* ロックを保持したまま待機

## 2相コミットの問題点

### ブロッキング問題(Blocking Problem)

* コーディネータ障害時
* 参加者が永久に待たされる可能性

### 性能低下

* 通信回数が多い
* ロック保持時間が長い

## 改良方式と関連知識

### 3相コミット(Three-Phase Commit)

* 2PCの欠点を軽減
* ただし実装が複雑

### 分散トランザクション代替手法

* Sagaパターン(補償トランザクション)
* Eventually Consistent な設計(NoSQL)

### CAP定理（Brewer's Theorem）

分散システムにおいて、以下の3つの性質を同時にすべて満たすことはできないという定理です。

| 性質 | 説明 |
|---|---|
| **C（Consistency：一貫性）** | すべてのノードが同じデータを返す |
| **A（Availability：可用性）** | すべてのリクエストに応答を返す |
| **P（Partition Tolerance：分断耐性）** | ネットワーク分断が発生しても動作を継続する |

#### CAP定理の実際の選択

ネットワーク分断（P）は避けられないため、実際にはCとAのトレードオフとなります。

| 選択 | 特徴 | 代表例 |
|---|---|---|
| CP型 | 一貫性重視。分断時は応答を停止する可能性 | 従来のRDBMS、HBase |
| AP型 | 可用性重視。分断時は古いデータを返す可能性 | DynamoDB、Cassandra |
| CA型 | 分断がない前提（単一ノード） | 単一サーバのRDBMS |

### BASE特性

CAP定理においてAP型を選択した場合のデータ整合性モデルです。ACIDと対比される概念です。

| 特性 | 説明 |
|---|---|
| **BA（Basically Available）** | 基本的に常に利用可能 |
| **S（Soft State）** | データの状態は時間とともに変化し得る |
| **E（Eventually Consistent）** | 最終的にはすべてのノードで一貫性が取れる |

| ACID | BASE |
|---|---|
| 強い一貫性 | 結果整合性 |
| 悲観的（ロック） | 楽観的 |
| RDBMSで採用 | NoSQLで採用 |

## NoSQLデータベース

RDBMSでは対応が難しい大規模データや高スループット要件に対応するデータベースの総称です。

### NoSQLの分類

| 種類 | 特徴 | 代表例 |
|---|---|---|
| **KVS（Key-Value Store）** | キーと値のペアでデータを管理。最もシンプル | Redis、Amazon DynamoDB |
| **ドキュメント指向DB** | JSONやBSON形式のドキュメント単位で管理 | MongoDB、CouchDB |
| **カラム指向DB（ワイドカラム）** | 列ファミリ単位でデータを管理。大規模分析向き | Apache Cassandra、HBase |
| **グラフDB** | ノードとエッジの関係性でデータを管理 | Neo4j |

### RDBMSとNoSQLの比較

| 項目 | RDBMS | NoSQL |
|---|---|---|
| データモデル | テーブル（行と列） | KVS/ドキュメント/グラフ等 |
| スキーマ | 固定スキーマ | スキーマレス（柔軟） |
| 整合性 | ACID（強い一貫性） | BASE（結果整合性） |
| スケーリング | スケールアップ中心 | スケールアウトに強い |
| 問い合わせ | SQL | 製品固有のAPI |
| トランザクション | 複数テーブルにまたがるトランザクション | 単一キー/ドキュメント単位が基本 |

## データベースのバックアップとリカバリ

### バックアップ方式

| 方式 | 説明 | 特徴 |
|---|---|---|
| フルバックアップ | データベース全体をバックアップ | 復旧が単純。時間・容量大 |
| 差分バックアップ | 前回のフルバックアップからの変更分 | フル＋最新の差分で復旧 |
| 増分バックアップ | 前回のバックアップ（種類問わず）からの変更分 | バックアップは高速。復旧時にフル＋全増分が必要 |

### バックアップ方式の比較

| 項目 | フル | 差分 | 増分 |
|---|---|---|---|
| バックアップ時間 | 長い | 中 | 短い |
| バックアップ容量 | 大 | 中 | 小 |
| 復旧時間 | 短い | 中 | 長い |
| 復旧に必要なもの | フルのみ | フル＋最新差分 | フル＋全増分 |

### リカバリの手順

1. 最新のフルバックアップからリストア
2. 差分/増分バックアップを順次適用
3. トランザクションログ（REDOログ）によるロールフォワードで障害直前まで復旧

## 全体整理表

### データベース技術の分類と試験頻出ポイント

| カテゴリ | キーワード | 試験での出題ポイント |
|---|---|---|
| 制約 | NOT NULL/CHECK/UNIQUE/PK/FK | 参照整合性制約、CASCADE/RESTRICT |
| 正規化 | 1NF〜BCNF | 関数従属性、部分関数従属/推移的関数従属の排除 |
| トランザクション | ACID、WAL、チェックポイント | ロールバック/ロールフォワードの使い分け |
| ロック | 共有/排他、デッドロック | 分離レベルとトランザクション異常の対応 |
| セキュリティ | SQLインジェクション、GRANT/REVOKE | **バインド機構（プレースホルダ）が最重要対策** |
| 暗号化・監査 | TDE、監査ログ、RLS | 多層防御の考え方 |
| 分散DB | 透過性、2相コミット | 6種類の透過性、ブロッキング問題 |
| CAP定理 | C/A/P、BASE特性 | CP型/AP型の選択、ACID vs BASE |
| NoSQL | KVS/ドキュメント/カラム/グラフ | RDBMSとの使い分け |
| バックアップ | フル/差分/増分 | 復旧手順、RPO/RTOとの関係 |

### 支援士試験で特に重要なセキュリティ関連DB知識

| テーマ | 午前IIでの出題 | 午後での出題 |
|---|---|---|
| SQLインジェクション | 対策手法の選択肢 | Webアプリケーション攻撃シナリオ |
| GRANT/REVOKE | WITH GRANT OPTION、CASCADE | アクセス制御設計 |
| ビューによるアクセス制御 | ビューの特性 | 権限設計の問題 |
| データベース暗号化 | TDE/列レベル暗号化 | 個人情報保護対策 |
| 監査ログ | 監査証跡の要件 | インシデント対応 |
