# 暗号技術とデジタル署名・証明書 ― CRYPTREC・ハッシュ・MAC・XML署名・PKI・タイムスタンプ・ブロックチェーンの体系整理

## はじめに

2025年10月のプロジェクトマネージャ試験受験を終え、2026年秋の情報処理安全確保支援士に向けて勉強中です。
本記事を含めた各知識のインデックスや学習の道のりについては、「[情報処理安全確保支援士への道のり(随時更新中)](https://qiita.com/teppei19980914/items/a25279a17b210d6ed9f4)」をご参照ください。
**本記事は学習した内容を記載しています。**

## 該当問題

[情報セキュリティスペシャリスト平成22年秋期 午前Ⅱ 問21](https://www.sc-siken.com/kakomon/22_aki/am2_21.html)
[情報セキュリティスペシャリスト平成25年春期 午前Ⅱ 問3](https://www.sc-siken.com/kakomon/25_haru/am2_3.html)
[情報セキュリティスペシャリスト平成26年春期 午前Ⅱ 問2](https://www.sc-siken.com/kakomon/26_haru/am2_2.html)
[情報セキュリティスペシャリスト平成26年秋期 午前Ⅱ 問4](https://www.sc-siken.com/kakomon/26_aki/am2_4.html)
[情報セキュリティスペシャリスト平成28年春期 午前Ⅱ 問9](https://www.sc-siken.com/kakomon/28_haru/am2_9.html)
[情報処理安全確保支援士平成29年秋期 午前Ⅱ 問4](https://www.sc-siken.com/kakomon/29_aki/am2_4.html)
[情報処理安全確保支援士令和2年秋期 午前Ⅱ 問5](https://www.sc-siken.com/kakomon/02_aki/am2_5.html)
[情報処理安全確保支援士令和3年秋期 午前Ⅱ 問8](https://www.sc-siken.com/kakomon/03_aki/am2_8.html)
[情報処理安全確保支援士令和4年春期 午前Ⅱ 問10](https://www.sc-siken.com/kakomon/04_haru/am2_10.html)
[情報処理安全確保支援士令和5年春期 午前Ⅱ 問6](https://www.sc-siken.com/kakomon/05_haru/am2_6.html)
[情報処理安全確保支援士令和5年秋期 午前Ⅱ 問3](https://www.sc-siken.com/kakomon/05_aki/am2_3.html)
[情報処理安全確保支援士令和5年秋期 午前Ⅱ 問4](https://www.sc-siken.com/kakomon/05_aki/am2_4.html)

## CRYPTREC

電子政府で利用する暗号技術を評価し、推奨するために、総務省/経産省/IPAを中心に構成された日本政府の暗号評価機関です。
つまり、政府システムで使ってよい暗号技術を決める公式委員会という位置づけにあります。

### なぜCRYPTRECが必要なのか

暗号技術は「時間とともに安全性が劣化」し、「有名な暗号でも突然実用不適」となることがあるからです。
PCの計算性能向上や新しい攻撃手法によって暗号技術の解読時間が短くなっています。
そのため、日本政府全体で共通の安全な暗号のリストを維持しなくてはいけないことから、CRYPTRECが登場しました。
したがって、CRYPTRECが提供している内容は日本政府にとって信頼できる暗号の基準を意味します。

### CRYPTRECの構成

CRYPTRECは3部門から構成されます。

* 暗号技術評価委員会
* 暗号技術の評価ワーキンググループ
* 暗号リストWG

### CRYPTRECの成果物

CRYPTRECの最も重要な役割は電子政府推奨暗号リストの作成です。
リストは大きく3種類に分割されます。

1. 電子政府推奨暗号リスト(Recommended Ciphers)
2. 適用候補暗号リスト(Candidate Ciphers)
3. 重点検討暗号

#### 電子政府推奨暗号リスト

政府システムで積極的に使用すべき暗号を表します。

* 暗号化(共通鍵暗号)
    * AES
    * CAMELLIA
* ハッシュ関数
    * SHA-256
    * SHA-3
* 公開鍵暗号
    * RSA
    * ECDSA/ECDH

#### 適用候補暗号リスト

現時点では使ってもよいが将来の推奨入りは未定を表します。

* CHACHA20
* POLY1305

#### 重点検討暗号

安全性懸念があり、新規利用は非推奨を表します。

* SHA-1
* 3DES
* RC4
* RSA 1024bit

### CRYPTRECの評価基準

CRYPTRECが暗号の安全性を評価する際は、国際的にも認められた要素が考慮されます。

#### 評価基準例

* 現在知られている攻撃に対し十分な安全性があるか
* 安全性の根拠が理論的に明確か
* 国際標準化(ISO/NIST)の状況
* 実装効率(ハードウェア/ソフトウェア)
* 将来の計算能力(量子コンピュータ)を見据えた安全性

### CRYPTRECが廃止を決めた暗号

* MD5
    → 衝突攻撃成功が証明され、電子署名用途としては即時廃止
* SHA-1
    → 実用衝突攻撃成功が証明され、電子署名/証明書では利用禁止
* RC4
    → 機密性を確保できないため、TLSからも完全排除
* 3DES
    → ブロック長が短く(64ビット)Birthday攻撃(Sweet32攻撃)の危険性があるため、将来的に廃止予定

## 共通鍵暗号（対称鍵暗号）

共通鍵暗号は、暗号化と復号に **同一の鍵（秘密鍵）** を使用する暗号方式です。
公開鍵暗号と比較して **高速** であり、大量データの暗号化に適しています。

### ブロック暗号とストリーム暗号

| 方式 | 処理単位 | 特徴 | 代表例 |
|:-----|:---------|:-----|:-------|
| ブロック暗号 | 固定長ブロック（128bit等） | 暗号利用モードと組み合わせて使用 | AES、Camellia、DES |
| ストリーム暗号 | 1bit/1byte単位 | リアルタイム通信向き、高速 | ChaCha20、RC4（非推奨） |

### AES（Advanced Encryption Standard）

NISTが2001年に標準化した **現行の最も重要なブロック暗号** です（FIPS 197）。

| 項目 | 内容 |
|:-----|:-----|
| ブロック長 | 128bit固定 |
| 鍵長 | 128 / 192 / 256 bit |
| 構造 | SPN構造（Substitution-Permutation Network） |
| ラウンド数 | 鍵長128→10回、192→12回、256→14回 |
| 設計者 | Joan Daemen, Vincent Rijmen（Rijndael） |

### DES / 3DES（レガシー暗号）

| 項目 | DES | 3DES |
|:-----|:----|:-----|
| ブロック長 | 64bit | 64bit |
| 鍵長 | 56bit | 112bit（2-key）/ 168bit（3-key） |
| 安全性 | 全数探索で解読可能（非推奨） | Sweet32攻撃の危険性（運用監視暗号） |

**DESは完全に非推奨、3DESもCRYPTREC運用監視暗号リスト** です。

### 暗号利用モード（Block Cipher Modes of Operation）

ブロック暗号は固定長のブロック単位で処理するため、任意長のデータを暗号化するには **暗号利用モード** が必要です。

| モード | 正式名称 | IV | 並列処理 | 特徴 | 安全性 |
|:-------|:---------|:---|:---------|:-----|:-------|
| ECB | Electronic Codebook | 不要 | 可 | 同一平文→同一暗号文（パターン漏洩） | **非推奨** |
| CBC | Cipher Block Chaining | 必要 | 暗号化:不可/復号:可 | 最も広く使われた伝統的モード | Padding Oracle攻撃に注意 |
| CTR | Counter | 必要（カウンタ） | 可 | ストリーム暗号的に動作、高速 | Nonce再利用禁止 |
| GCM | Galois/Counter Mode | 必要 | 可 | **CTR + 認証タグ（GHASH）** | TLS 1.3で推奨 |
| CCM | Counter with CBC-MAC | 必要 | 不可 | CTR + CBC-MACで認証付き暗号化 | 無線LAN等で使用 |

#### ECBモードの危険性

同一の平文ブロックが同一の暗号文ブロックになるため、**データのパターンが暗号文に漏洩** します。
午前問題で「ECBモードの問題点」として頻出です。

#### CBC モード

前ブロックの暗号文と現ブロックの平文をXORしてから暗号化します。
最初のブロックは **IV（初期化ベクトル）** とXORします。

```
平文[1] ⊕ IV → AES暗号化 → 暗号文[1]
平文[2] ⊕ 暗号文[1] → AES暗号化 → 暗号文[2]
```

#### GCMモード（認証付き暗号化：AEAD）

CTRモードで暗号化しつつ、**GHASHで認証タグを生成** します。
暗号化と完全性検証を同時に行える **AEAD（Authenticated Encryption with Associated Data）** の代表です。

- **TLS 1.3では GCMが標準** です
- AES-GCMは午前・午後ともに頻出です

### 試験ポイント

- **ECBの危険性（パターン漏洩）** は午前定番問題です
- **CBCモードのIVの必要性** が問われます
- **GCM = 認証付き暗号化（AEAD）** の理解が重要です
- AESの鍵長（128/192/256bit）とブロック長（128bit固定）の区別が必要です

## 疑似乱数(PRNG: Pseudo Random Number Generator)

疑似乱数とは **決定論的アルゴリズムによって生成される乱数列** のことです。
種(Seed)が同じであれば同じ乱数列を生成します。

### PRNGの分類(エビデンス: NIST SP 800-90A Rev.1)

#### 非暗号学的 PRNG

例: LCG, Mersenne Twister

- 予測されやすいです
- 統計的には良いですが、暗号用途では不適です
- 内部状態が露呈すると将来の値が推測可能です

#### 暗号学的 PRNG(CSPRNG)

例: Hash_DRBG, HMAC_DRBG, CTR_DRBG

- 出力から内部状態が推測不能です
- Forward/Backward secrecy を満たします
- 鍵、Nonce、IV生成に必須です

## 暗号学的ハッシュ関数(NIST FIPS 180-4)

暗号学的ハッシュ関数は **任意長のデータを固定長に圧縮する一方向関数** です。

### 暗号学的性質(3要件)

| 名称 | 意味 | 説明 |
|------|------|------|
| **原像困難性** | h = H(x) から x を求めるのが困難 | 2^n の計算量 |
| **第二原像困難性** | 同じハッシュ値を与える別の入力 x' を見つけるのが困難 | 2^n の計算量 |
| **衝突困難性(衝突発見困難性)** | 異なる x, x' で H(x)=H(x') を見つけるのが困難 | 2^(n/2) の計算量 |

### 衝突発見困難性(Collision Resistance)

衝突発見困難性とは、**異なる2つの入力が同じハッシュ値になる衝突を見つけることが困難である性質**のことです。

#### なぜ「2^(n/2)」になるのか(誕生日攻撃)

- 衝突探索問題は「誕生日のパラドックス」に基づきます
- n ビットのハッシュ値の衝突発見計算量は **2^(n/2)** です
- 例: SHA-256 → **2^128** の計算量です

#### SHA-1 が廃止された理由

Google による **SHAttered(2017)** で実際に衝突が生成されたためです。

衝突実現は以下を可能にする危険があります。

- 電子署名の改ざん
- 証明書偽装
- ファイルの完全性破壊

### ハッシュ関数の代表例

| アルゴリズム | 規格 | 安全性 |
|--------------|------|--------|
| SHA-1 | FIPS 180-4 | 衝突実証済みで非推奨 |
| SHA-2(SHA-256/512) | FIPS 180-4 | 現行の標準 |
| SHA-3 | FIPS 202 | Keccakベース |

## MAC(Message Authentication Code)

MACは **メッセージの改ざん検知 + 送信元認証** を提供します。

### HMAC(RFC 2104)

- ハッシュ関数 + 秘密鍵を使用します
- SHA-256 などを利用します
- TLS, IPsec などで標準使用されています

### CMAC(NIST SP 800-38B)

- AES などのブロック暗号を利用します
- 高速でハードウェア実装に向いています

### UMAC/VMAC

- 大量データ処理向け高速MACです

### PRNG/ハッシュ/MAC の関係性

| 技術 | 関係 |
|------|------|
| PRNG | MACの鍵/Nonce/IV生成に使用 |
| ハッシュ関数 | HMACやデジタル署名の基盤となる |
| MAC | 改ざん防止と送信元認証を提供 |

### MAC とデジタル署名の比較

| 項目 | MAC | デジタル署名 |
|------|------|--------------|
| 鍵 | 共通鍵 | 公開鍵/秘密鍵 |
| 機能 | 改ざん検知/送信元認証 | 否認防止/改ざん検知 |
| 代表方式 | HMAC, CMAC | RSA, ECDSA |

## 公開鍵暗号（非対称鍵暗号）

公開鍵暗号は、**暗号化と復号に異なる鍵（公開鍵と秘密鍵）** を使用する暗号方式です。

### 共通鍵暗号と公開鍵暗号の比較

| 観点 | 共通鍵暗号 | 公開鍵暗号 |
|:-----|:-----------|:-----------|
| 鍵の種類 | 暗号化・復号とも同一鍵 | 公開鍵と秘密鍵のペア |
| 処理速度 | **高速** | 低速（数百～数千倍遅い） |
| 鍵配送問題 | あり（安全な経路が必要） | **なし**（公開鍵は公開可能） |
| 鍵管理数 | n人で n(n-1)/2 個 | n人で 2n 個 |
| 主な用途 | データ暗号化 | 鍵交換、デジタル署名、認証 |
| 代表例 | AES、Camellia | RSA、ECDSA、ECDH |

### RSA暗号

素因数分解の困難性に基づく公開鍵暗号です。暗号化と署名の両方に使用できます。

| 項目 | 内容 |
|:-----|:-----|
| 安全性の根拠 | 大きな合成数の素因数分解の困難性 |
| 鍵長 | 2048bit以上を推奨（CRYPTREC） |
| 用途 | 暗号化、デジタル署名 |
| 特徴 | 歴史が長く広く普及、鍵長が大きい |

#### RSA暗号の原理（概要）

1. 2つの大きな素数 p, q を選び、n = p × q を計算
2. 公開鍵 (e, n) と秘密鍵 (d, n) を生成
3. 暗号化：C = M^e mod n
4. 復号：M = C^d mod n

### 楕円曲線暗号（ECC：Elliptic Curve Cryptography）

楕円曲線上の離散対数問題の困難性に基づく暗号方式です。

| 項目 | 内容 |
|:-----|:-----|
| 安全性の根拠 | 楕円曲線上の離散対数問題（ECDLP） |
| 鍵長 | 256bitでRSA 3072bit相当の安全性 |
| 利点 | **短い鍵長で高い安全性**、高速処理 |
| 代表的な方式 | ECDSA（署名）、ECDH（鍵交換）、Ed25519（署名） |

#### RSAとECCの鍵長比較

| 安全性レベル | RSA鍵長 | ECC鍵長 |
|:-------------|:--------|:--------|
| 80bit相当 | 1024bit | 160bit |
| 112bit相当 | 2048bit | 224bit |
| 128bit相当 | 3072bit | **256bit** |
| 256bit相当 | 15360bit | 521bit |

### Diffie-Hellman鍵交換（DH）

通信路上で盗聴されても **共通の秘密鍵を安全に共有** できるプロトコルです。

#### DHの流れ

```
Alice                          Bob
  a（秘密値）を選択               b（秘密値）を選択
  A = g^a mod p を送信 →
                        ← B = g^b mod p を送信
  共有鍵 = B^a mod p            共有鍵 = A^b mod p
  ※どちらも g^(ab) mod p となり一致
```

- 盗聴者は A, B, g, p を知っても、a, b を求められません（離散対数問題）
- **中間者攻撃（MITM）には脆弱** であり、認証と併用が必要です

#### ECDH（楕円曲線DH）

DHを楕円曲線上で実現したもので、短い鍵長で同等の安全性を提供します。

#### DHE / ECDHE（エフェメラルDH）

鍵交換のたびに **一時的な（エフェメラル）鍵ペアを生成** する方式です。
**前方秘匿性（PFS：Perfect Forward Secrecy）** を実現します。

- 秘密鍵が漏洩しても、**過去の通信は復号できません**
- **TLS 1.3ではECDHEが必須** です

### ハイブリッド暗号方式

**公開鍵暗号の鍵配送の利点** と **共通鍵暗号の高速性** を組み合わせた実用的な方式です。

#### ハイブリッド暗号の流れ

```
送信者:
  1. ランダムなセッション鍵（共通鍵）を生成
  2. データをセッション鍵（AES等）で暗号化
  3. セッション鍵を受信者の公開鍵（RSA等）で暗号化
  4. 暗号化データ + 暗号化セッション鍵を送信

受信者:
  1. 秘密鍵でセッション鍵を復号
  2. セッション鍵でデータを復号
```

- **TLS、S/MIME、PGP** などで広く採用されています
- 午後問題で「なぜ共通鍵と公開鍵を併用するのか」が問われます

## デジタル署名の基本原理

### デジタル署名とは

デジタル署名は、公開鍵暗号技術を利用して **完全性（改ざん検知）・認証（本人確認）・否認防止** を実現する技術です。

### デジタル署名の処理フロー

```
【署名生成】
  1. 対象データのハッシュ値を計算（SHA-256等）
  2. ハッシュ値を送信者の秘密鍵で暗号化 → 署名値

【署名検証】
  1. 受信データのハッシュ値を計算
  2. 署名値を送信者の公開鍵で復号
  3. 両者を比較 → 一致すれば正当
```

### 主要な署名アルゴリズム

| アルゴリズム | 安全性の根拠 | 鍵長 | 特徴 |
|:-------------|:-------------|:-----|:-----|
| RSA署名 | 素因数分解 | 2048bit以上 | 広く普及、署名と暗号化の両方に対応 |
| DSA | 離散対数 | 2048bit以上 | 署名専用（暗号化不可） |
| ECDSA | 楕円曲線離散対数 | 256bit | 短い鍵長、高速、TLS 1.3で推奨 |
| Ed25519 | 楕円曲線（Curve25519） | 256bit | 高速、実装が容易、SSH等で利用 |

### デジタル署名が提供するセキュリティ特性

| 特性 | 内容 |
|:-----|:-----|
| 完全性 | データが改ざんされていないことを検証 |
| 認証 | 署名者が秘密鍵の保有者であることを確認 |
| 否認防止 | 署名者が署名行為を否定できないことを保証 |

**注意：デジタル署名は「機密性」を提供しません。** 機密性が必要な場合は暗号化を併用します。

### 長期署名（CAdES / PAdES / XAdES）

電子署名は証明書の有効期限や暗号アルゴリズムの危殆化により、**長期的な検証が困難** になります。
長期署名はタイムスタンプと検証情報を付加することで、この問題を解決します。

| 形式 | 対象 | 特徴 |
|:-----|:-----|:-----|
| CAdES | バイナリデータ | CMS署名を拡張 |
| PAdES | PDFドキュメント | PDF内に署名を埋め込み |
| XAdES | XMLデータ | XML署名を拡張 |

#### 長期署名のレベル

| レベル | 内容 |
|:-------|:-----|
| -BES | 基本電子署名（証明書付き） |
| -T | タイムスタンプ付加 |
| -C | 証明書チェーン＋失効情報への参照 |
| -X | 検証情報にタイムスタンプ付加 |
| -XL | 検証情報を署名に埋め込み |
| -A | アーカイブタイムスタンプ（最長保存） |

## S/MIME と PGP

### S/MIME（Secure/Multipurpose Internet Mail Extensions）

S/MIMEは、電子メールに **暗号化とデジタル署名** を提供する標準規格です。

| 項目 | 内容 |
|:-----|:-----|
| 信頼モデル | **階層型（PKI/CA）** |
| 証明書 | X.509証明書（CAが発行） |
| 暗号方式 | ハイブリッド暗号（RSA/AES等） |
| 標準 | RFC 8551 |

### PGP（Pretty Good Privacy）/ OpenPGP

PGPは、**Web of Trust（信頼の輪）** モデルに基づくメール暗号化・署名の方式です。

| 項目 | 内容 |
|:-----|:-----|
| 信頼モデル | **分散型（Web of Trust）** |
| 証明書 | PGP鍵（利用者同士が相互に署名） |
| 暗号方式 | ハイブリッド暗号（RSA/AES等） |
| 標準 | RFC 4880（OpenPGP） |

### S/MIME と PGP の比較

| 観点 | S/MIME | PGP |
|:-----|:-------|:----|
| 信頼モデル | CA（認証局）による階層型 | Web of Trust（相互署名） |
| 鍵管理 | CAが証明書を発行・管理 | 利用者自身が鍵を管理 |
| 導入のしやすさ | 企業向け（CA基盤が必要） | 個人向け（CAは不要） |
| 証明書 | X.509 | PGP鍵 |
| 主な用途 | 企業メール、電子契約 | 個人間の暗号化メール |

### 試験ポイント

- S/MIMEとPGPの **信頼モデルの違い（PKI vs Web of Trust）** は午前問題で頻出です
- 両者とも **ハイブリッド暗号** を使用する点は共通です

## XMLデジタル署名(W3C 勧告に基づく解説)

XMLデジタル署名(XML Signature)は、**XML文書に電子署名を適用するための国際標準仕様**であり、W3C と IETF が共同策定した **W3C勧告「XML Signature Syntax and Processing」** に基づいています。

電子署名として必要な以下の性質を XML 文書上で実現します。

- **完全性(改ざん検知)**
- **認証(署名者の識別)**
- **否認防止**

特に XML は構造に自由度があり、空白や属性順序の違いで別文書と解釈されるため、**署名前処理(Transform)や正規化(Canonicalization)が不可欠**です。

### XML署名の基本構造(W3C 正式仕様)

```xml
<Signature xmlns="http://www.w3.org/2000/09/xmldsig#">

    <SignedInfo>
        <!-- 署名対象のURI、Transform、正規化、ハッシュ方式など -->
    </SignedInfo>

    <SignatureValue>
        <!-- SignedInfo を署名者の秘密鍵で署名した値 -->
    </SignatureValue>

    <KeyInfo>
        <!-- 公開鍵・X.509証明書など（任意） -->
    </KeyInfo>

</Signature>
```

#### SignedInfo

署名対象データ、Transform、ハッシュアルゴリズムを定義するブロックです。
XML署名では **文書そのものではなく、この SignedInfo 部分に対して署名を施す**ことが特徴です。
「署名対象のURI」は「\<Reference URI="署名対象のURI"\>」のように「Reference属性」に記述します。

#### SignatureValue

SignedInfo を秘密鍵で署名した値です。
検証時には公開鍵で SignatureValue を確認します。

#### KeyInfo(任意)

公開鍵情報や証明書を含められます。
セキュリティ方針により外部鍵管理とする場合は省略されます。

### 署名形式(Detached / Enveloped / Enveloping)

XML署名では、**署名が文書中のどこに配置されるか**によって形式が分かれます。

#### Detached Signature(デタッチ署名)

- 署名と署名対象が物理的に分離されています
- `<Reference URI="http://example.com/data.xml">` のように外部リソースを指定します
- 既存文書を改変できない場合に適します
- バイナリデータにも利用可能です

#### Enveloped Signature(エンベロープ署名)

署名対象 XML 文書の内部に `<Signature>` が埋め込まれる形式です。

```xml
<Document>
    <Data> ... </Data>
    <Signature> ... </Signature>
</Document>
```

- 文書全体をまとめて扱いやすいです
- 署名自身を署名対象に含めないため、Transform に **Enveloped Signature Transform** が必要です

#### Enveloping Signature(エンベローピング署名)

署名文書がデータを内包する形式です。

```xml
<Signature>
    <Object>・・・署名対象データ・・・</Object>
</Signature>
```

- 署名とデータを "1つの XML として配布したい" 場合に便利です
- XML署名が"容器"となり、複数の `<Object>` を含めることも可能です

### 正規化(Canonicalization: C14N)

XML は以下の違いだけで別文書として扱われます。

- 空白・改行
- 属性の順序
- XML 宣言の有無
- 名前空間の扱い

署名時の入力文書と検証時の文書が少しでも異なると検証に失敗するため、**正規化(C14N: Canonical XML)によって XML を唯一の形に統一** します。

例:
- `xmlns` の統一
- 属性順序の並べ替え
- 無駄な空白の除去

W3C は **Canonical XML 1.0 / 1.1**, **Exclusive Canonical XML** を勧告しています。

### Transform(署名前処理)

XML署名では署名対象データに対する前処理を **Transform 要素**で定義します。

代表例:

- **Canonicalization(正規化)**
- **XPath Transform(署名範囲の絞り込み)**
- **Enveloped Signature Transform**
  → エンベロープ署名で `<Signature>` を署名対象から除く目的です

Transform は **XMLの柔軟性による"改ざんではない差異"を吸収する**ためのしくみです。

### XML(Extensible Markup Language)

XML は W3C が策定した **構造化データを表現するためのマークアップ言語**です。

- HTML が「見た目」を記述するのに対し、XML は「データ構造」を表現します
- 階層構造で意味を表すため、電子署名の対象として扱いやすいです
- SOAP、SAML、電子政府システムなど多くの分野で利用されています

### W3C(World Wide Web Consortium)

W3C はティム・バーナーズ＝リーらが主導する **Web 技術の標準化団体**です。

- HTML / CSS / XML / SVG
- WebCrypto API
- XML Signature / XML Encryption

など、Web の基盤となる技術仕様を策定しています。

### XML署名の周辺知識

#### XML Encryption(XML暗号)

XML署名が「完全性」を担保するのに対し、**XML Encryption は「機密性」を XML レベルで実現する**ための標準仕様です。
署名と併用することが多いです。

#### XAdES(XML Advanced Electronic Signatures)

EU の電子署名法に基づく **高度電子署名規格**で、XML署名を拡張したものです。
タイムスタンプや長期検証情報の付加が可能です。

#### SAML(Security Assertion Markup Language)

シングルサインオン(SSO)で利用される認証情報を XML でやりとりする枠組みです。
SAML のアサーションには XML署名が利用されます。

#### SOAP・WS-Security

Webサービスの世界では、SOAP メッセージに対して XML署名や暗号化を適用できます。

## デジタル証明書(X.509)と PKI

### なぜ PKI が必要なのか

ユーザが「https://example.com」にアクセスするとき、次の疑問が必ず発生します。

- このサーバは本当に"example.com"なのか
- 公開鍵は本物なのか、誰かが偽サイトを作っていないか

**これを保証する技術が PKI(公開鍵基盤)です。**
PKI の目的は、**公開鍵を安全に信用できる状態にすること**です。

### PKI の構成要素

#### CA(Certification Authority: 認証局)

- 利用者へ**X.509公開鍵証明書**を発行する主体です
- インターネット世界における「信頼の根」です
- EV証明書などは**CA/B Forum**により審査基準が標準化されています

#### RA(Registration Authority: 登録局)

- 証明書申請者の本人確認を実施します
- 証明書発行は行わず、CAの前段階処理を担います

#### VA(Validation Authority: 証明書有効性検証局)

- クライアントからのリアルタイムの問合せにはOCSP(Online Certificate Status Protocol)やSCVPが用いられ、VAにはレスポンダ(サーバ)の機能が実装されます
- 以下の方法で公開鍵証明書の有効性を検証し、クライアントからの証明書の有効性に関する問い合わせに応答します
    * CAの公開鍵で署名を検証
    * 証明書の有効期限を確認
    * CRLの集中管理
    * CRLを確認

#### AA(Attribute Authority: 属性認証局)

- CAに代わり属性証明書を発行します

#### Repository

証明書/CRL を公開するサーバです。

#### Subscriber(利用者)

証明書を利用して認証/署名/暗号化を行う主体です。

### X.509 デジタル証明書とは(RFC 5280)

証明書は **公開鍵の身分証明書**です。

#### 主な構造

証明書は「CA が署名した公開鍵の名刺」です。

- Subject(誰の証明書か)
- Issuer(どの CA が保証したか)
- Public Key
- Validity(有効期間)
- Extensions(用途制限など)
- CA Signature(CA の電子署名)

### 重要拡張領域

#### Key Usage

暗号化、署名など利用用途を制限します。

#### EKU(Extended Key Usage)

serverAuth/clientAuth など詳細用途を表します。

#### SAN(Subject Alternative Name)

複数 FQDN を 1 枚にまとめます。
※ブラウザは CNではなく **SAN をチェック**します。

#### CRL Distribution Points/AIA

失効確認用 URL(CRL/OCSP)を格納します。

### PKI の信頼チェーン

```
Root CA
  ↓
Intermediate CA
  ↓
End Entity(Web サーバ等)
```

ブラウザは下記を行い、安全性を判断します。

1. 署名検証
2. チェーンの正しさ
3. 有効期間
4. SAN の一致
5. 失効状態の確認

### 証明書失効(Revocation)

証明書が有効期間中でも無効化される場合を表します。

代表例:
- 秘密鍵漏洩
- 組織変更
- サーバ廃止
- 誤発行

### CRL(Certificate Revocation List: 失効証明書リスト)

有効期限内であるにもかかわらず、秘密鍵の漏えい、紛失、証明書の被発行者の規則違反などの理由により安全性が担保されなくなったために、失効となったデジタル証明書の一覧表です。

#### CRLの構造(ASN.1)

```
CertificateList ::= SEQUENCE {
  tbsCertList          TBSCertList,
  signatureAlgorithm   AlgorithmIdentifier,
  signatureValue       BIT STRING
}

TBSCertList ::= SEQUENCE {
  version                Version OPTIONAL,
  signature              AlgorithmIdentifier,
  issuer                 Name,
  thisUpdate             Time,
  nextUpdate             Time OPTIONAL,
  revokedCertificates    SEQUENCE OF RevokedCertificate OPTIONAL,
  crlExtensions          Extensions OPTIONAL
}
```

#### RevokedCertificate の要素

- **serialNumber**
- **revocationDate**
- **extensions(失効理由、invalidityDate など)**

#### thisUpdate

CRLが発行された日時です。

#### nextUpdate

次回CRLが更新されるべき日時です。
この時刻を過ぎているCRLは信頼できません。

#### CRLの運用上の課題

- **CRLファイルの巨大化**: 発行数が増えるほどCRLが大きくなり、クライアントのダウンロード負担が増えます
- **リアルタイム性が低い**: CRLは「定期更新」であり、即時の失効反映はできません
- **大規模PKIでは非効率**: 証明書数が数百万枚を超えるとCRLだけでは運用困難になります

#### Delta CRL(差分CRL)

RFC 5280準拠の仕組みで、**CRLの差分のみ配布して効率を改善する方式**です。

##### 利点

- ネットワーク負荷を削減します
- 大規模環境で有効です

##### 注意点(午後問題向け)

- Delta CRL単体では不可です
- **Base CRL と併せて検証する必要があります**

#### CRL検証手順

1. **CRL署名検証**
2. thisUpdate/nextUpdate の妥当性確認
3. 対象証明書の serialNumber が revokedCertificates に含まれているか確認
4. 必要に応じて reasonCode の内容を参照
5. Base CRL + Delta CRL を併用する場合は整合性確認

### OCSP(Online Certificate Status Protocol)

証明書の失効状態をリアルタイムに問い合わせます。

#### 応答

- good(有効)
- revoked(失効)
- unknown(不明)

#### 利点

- CRL より最新性が高いです
- 必要な証明書だけ確認するため効率的です

### OCSP Stapling(RFC 6066)

Web サーバが事前に OCSP 応答を取得し、TLS ハンドシェイク時にクライアントへ提供する方式です。

#### メリット

- 高速化します
- プライバシーを保護します
- OCSP サーバの負荷を軽減します

### 証明書の種類

| 種類 | 用途 |
|------|------|
| サーバ証明書 | HTTPS、TLS通信 |
| クライアント証明書 | 利用者認証 |
| コード署名証明書 | ソフトウェア署名 |
| S/MIME 証明書 | メール署名/暗号化 |

### CA/B Forum Baseline Requirements

商用 CA が従う国際標準です。

- サーバ証明書の有効期間は **398日以内**です
- ドメイン所有確認の標準化が行われています
- 失効対応の統一が図られています

## タイムスタンプとその効果

### タイムスタンプとは何か

#### 定義

- RFC 3161(Time-Stamp Protocol: TSP)
- 総務省「タイムスタンプ技術解説」
- 電子署名法関連ガイドライン

**タイムスタンプとは、ある電子データが「ある時刻に確実に存在していた」ことを第三者が証明する仕組みです。**

#### タイムスタンプの本質

タイムスタンプは次の2点を証明します。

1. **存在証明**: その時刻にそのデータが存在していたことです
2. **非改ざん性の担保**: その後、内容が変更されていないことです

→ **「誰が作ったか」は証明しない**点が非常に重要です。

### タイムスタンプの仕組み

#### 基本構造

```
利用者
↓(ハッシュ値送信)
TSA(時刻認証局)
↓(署名付きタイムスタンプ)
利用者
```

- TSA: Time Stamping Authority(時刻認証局)

#### 処理の流れ

1. 対象データの **ハッシュ値** を計算します
2. ハッシュ値を TSA に送信します
3. TSA が時刻情報と受け取ったハッシュ値を **電子署名** します
4. 利用者は署名付き時刻情報を受領します

→ **元データそのものは TSA に渡さない**ため、安全性が高いです。

### タイムスタンプの効果

#### 効果1: 存在証明(存在時刻の証明)

下記のようなデータで利用され、「このデータは **この時刻より前には存在していた**」ことを証明します。

- 契約書
- 設計書
- ログデータ

#### 効果2: 改ざん検知

- 元データのハッシュ値が変わります
- タイムスタンプ検証に失敗します

→ **タイムスタンプ以降の改ざんが検出可能**です。

#### 効果3: 電子署名の有効期限問題の解消

電子署名には下記弱点があります。

- 証明書には **有効期限** があります
- 失効すると、後から署名の正当性が疑われます

##### タイムスタンプ付与の効果

「証明書が有効だった時点で署名されていた」ことを証明できます。
→ **長期署名(Long-Term Signature)を可能**にします。

### タイムスタンプと電子署名の関係

| 項目 | 電子署名 | タイムスタンプ |
|---|---|---|
| 本人性 | 証明できる | 証明しない |
| 改ざん検知 | 可能 | 可能 |
| 時刻の証明 | 不十分 | **可能** |
| 有効期限対策 | 弱い | **補完可能** |

→ **両者は競合ではなく補完関係**です。

### RFC 3161(Time-Stamp Protocol)

- IETF による国際標準です
- ハッシュアルゴリズム + 電子署名を使用します
- X.509 証明書を利用します

→ **PKI 技術の一部として位置付けられます**

### 法的証拠能力との関係

- 電子帳簿保存法
- 電子契約
- 内部統制(証跡管理)

これらでは、タイムスタンプ付きデータであること、改ざん検知可能であることが重要視されます。

## ブロックチェーン(Blockchain)

### ブロックチェーンとは(定義)

#### 定義(エビデンス)

- Satoshi Nakamoto, *Bitcoin: A Peer-to-Peer Electronic Cash System*
- NIST IR 8202
- IPA「ブロックチェーン技術概要」

**ブロックチェーンとは、取引データをまとめたブロックを時系列に連結し、それを分散管理することで、改ざん耐性と可用性を実現する分散型台帳技術です。**

### ブロックチェーンの基本構造

#### ブロックの構成要素

1つのブロックは主に次の情報で構成されます。

| 要素 | 内容 |
|---|---|
| 取引データ | トランザクションの集合 |
| 前ブロックのハッシュ値 | 直前ブロックとの連結 |
| タイムスタンプ | 作成時刻 |
| ナンス(Nonce) | 合意形成で使用 |
| 自身のハッシュ値 | ブロック全体の要約 |

→ **「前ブロックのハッシュ値」を含むことが最大の特徴**です。

#### チェーン構造の意味

```
Block(n-1) ──hash──▶ Block(n) ──hash──▶ Block(n+1)
```

- 過去のブロックを改ざんすると、以降すべてのハッシュが不整合になります

→ **連鎖構造による改ざん検知/抑止**が実現されます。

### 改ざんが困難な理由

#### ハッシュ関数による完全性保証

- ハッシュ関数の性質(SHA-256 等)
  - 一方向性
  - 衝突困難性
  - 微小変更で出力が激変

→ 取引データを1ビット変更すると、ブロック全体のハッシュが変わります。

#### 分散管理(P2Pネットワーク)

- 台帳は **複数ノードで共有** されます
- 中央サーバは不要です
- 多数決(合意形成)で正当なチェーンを決定します

→ 一部ノードの改ざんは無効化されます。

#### 合意形成アルゴリズム(Consensus)

| 方式 | 特徴 |
|---|---|
| PoW(Proof of Work) | 計算量による正当性 |
| PoS(Proof of Stake) | 保有量に応じた権利 |
| PBFT | 実用向け高速合意 |

→ 攻撃者が改ざんするには**膨大な計算資源または支配力が必要**です。

### ブロックチェーンのセキュリティ特性

#### 提供される性質(CIA 観点)

| 観点 | 実現方法 |
|---|---|
| 完全性(Integrity) | ハッシュ連鎖 |
| 可用性(Availability) | 分散管理 |
| 認証/否認防止 | 電子署名 |

**※ 機密性(Confidentiality)は標準では弱いです**
**→ 必要に応じて暗号化/許可型設計を採用します**

### 電子署名との関係

- 各取引は **送信者の秘密鍵で署名** されます
- 公開鍵で検証可能です
- なりすまし防止/否認防止を実現します

→ ブロックチェーン = **ハッシュ + 電子署名 + 分散合意** です。

### パブリック型とプライベート型

| 種別 | 特徴 | 例 |
|---|---|---|
| パブリック | 誰でも参加可 | Bitcoin, Ethereum |
| プライベート | 管理者あり | 企業内台帳 |
| コンソーシアム | 限定参加 | 金融業界 |

### 51%攻撃

- 計算能力(またはステーク)の過半数を支配します
- 不正チェーンを正当と認識させる攻撃です

→ 分散度が低いほどリスクが増大します。

### スマートコントラクト

- ブロックチェーン上で自動実行される契約です
- 例: Ethereum

#### リスク

- バグがあると修正困難です
- DAO事件(2016)が代表例です

### ブロックチェーンとデータベースの違い

| 観点 | ブロックチェーン | RDB |
|---|---|---|
| 改ざん耐性 | 高い | 低い |
| 性能 | 低め | 高速 |
| 管理者 | 不要/分散 | 必要 |
| 更新 | 追記のみ | 更新可 |

## 周辺知識

### NISTの暗号標準

* AES(FIPS-197)
* SHA-2(FIPS-180-4)
* SHA-3(FIPS-202)

### ISO/IEC暗号標準

* AES(ISO/IEC 18033-3)
* RFC/ISO のハイブリッドも多いです

### PQC(耐量子暗号: Post Quantum Cryptography)

NISTが進めている新しい暗号標準化プロジェクトです。
量子コンピュータ時代に向けてCRYSTALS-Kyberなどが選定されています。

### TLSの暗号スイート

CRYPTREC推奨暗号はTLSの暗号スイートにも反映されています。

### KDF(Key Derivation Function)

PBKDF2/HKDF/Argon2 などがあります。
弱いパスワードから安全な鍵を導出します。

### Nonce(Number used once)

チャレンジレスポンス、暗号モードで再利用が禁止されています。

### HSM(Hardware Security Module)

CA の秘密鍵を厳重に保護する装置です。

### PFS(Perfect Forward Secrecy)

ECDHE などにより、秘密鍵漏洩でも過去通信を守ります。

### ACME(Let's Encrypt)

証明書自動発行プロトコルです。

---

## まとめ

### 暗号アルゴリズム比較表

| 分類 | アルゴリズム | 鍵長(ビット) | 特徴 | 安全性 |
|------|-------------|-------------|------|--------|
| 共通鍵(ブロック) | AES | 128/192/256 | SPN構造、現在の標準 | ○(推奨) |
| 共通鍵(ブロック) | 3DES | 112/168 | DESの3回適用 | △(2023年以降非推奨) |
| 共通鍵(ブロック) | Camellia | 128/192/256 | 日本発、AES同等 | ○(推奨) |
| 共通鍵(ストリーム) | ChaCha20 | 256 | 軽量・高速 | ○(推奨) |
| 公開鍵(暗号化) | RSA | 2048以上 | 素因数分解問題 | ○(2048bit以上) |
| 公開鍵(暗号化) | ElGamal | - | 離散対数問題 | △(実用少) |
| 公開鍵(鍵交換) | DH | 2048以上 | 離散対数問題 | ○(DHE推奨) |
| 公開鍵(鍵交換) | ECDH/ECDHE | 256以上 | 楕円曲線離散対数問題 | ○(ECDHE推奨) |
| 公開鍵(署名) | RSA署名 | 2048以上 | 素因数分解問題 | ○ |
| 公開鍵(署名) | DSA | 2048/3072 | 離散対数問題 | △(非推奨傾向) |
| 公開鍵(署名) | ECDSA | 256以上 | 楕円曲線離散対数問題 | ○(推奨) |
| 公開鍵(署名) | Ed25519 | 256(固定) | EdDSA、高速・安全 | ○(推奨) |

### 暗号利用モード比較表

| モード | 並列処理 | IV/Nonce | 認証 | 用途・特徴 |
|--------|---------|----------|------|-----------|
| ECB | ○ | 不要 | × | **使用禁止**：同一平文→同一暗号文 |
| CBC | 暗号化× / 復号○ | IV必要 | × | TLS(旧)、ディスク暗号化 |
| CFB | × | IV必要 | × | ストリーム的利用 |
| OFB | × | IV必要 | × | ストリーム的利用 |
| CTR | ○ | Nonce+カウンタ | × | 高速並列処理向き |
| GCM | ○ | Nonce必要 | ○(AEAD) | **TLS 1.3標準**、暗号化+認証 |
| CCM | × | Nonce必要 | ○(AEAD) | 無線LAN(WPA2/WPA3) |

### 共通鍵暗号と公開鍵暗号の比較

| 項目 | 共通鍵暗号 | 公開鍵暗号 |
|------|-----------|-----------|
| 鍵の数 | 通信相手ごとに1つ(n人でn(n-1)/2個) | 各人2つ(公開鍵+秘密鍵、n人で2n個) |
| 処理速度 | 高速(公開鍵の100～1000倍) | 低速 |
| 鍵配送問題 | あり(安全な鍵共有が必要) | なし(公開鍵は公開可能) |
| 代表アルゴリズム | AES, Camellia, ChaCha20 | RSA, ECC, ElGamal |
| 主な用途 | データの暗号化(大量データ) | 鍵交換、デジタル署名、少量データ暗号化 |
| ハイブリッド暗号 | セッション鍵として使用 | セッション鍵の暗号化に使用 |

### ハッシュ関数比較表

| アルゴリズム | 出力長(ビット) | 安全性 | 備考 |
|-------------|---------------|--------|------|
| MD5 | 128 | ×(衝突発見済) | 使用禁止 |
| SHA-1 | 160 | ×(衝突発見済) | 2017年以降非推奨 |
| SHA-256 | 256 | ○ | SHA-2ファミリ、現在の標準 |
| SHA-384 | 384 | ○ | SHA-2ファミリ |
| SHA-512 | 512 | ○ | SHA-2ファミリ |
| SHA-3(SHA3-256等) | 224/256/384/512 | ○ | Keccak構造、SHA-2と異なる設計 |

### デジタル署名・証明書の構成要素

| 構成要素 | 役割 | 試験での出題ポイント |
|---------|------|-------------------|
| CA(認証局) | 証明書の発行・失効管理 | 階層構造、ルートCA/中間CA |
| RA(登録局) | 申請者の本人確認 | CAとの役割分担 |
| CRL | 失効証明書リスト | 定期発行、タイムラグが課題 |
| OCSP | リアルタイム失効確認 | CRLとの比較、OCSPステープリング |
| 証明書チェーン | ルートCAまでの信頼の連鎖 | 検証手順が午後問題で頻出 |
| DV/OV/EV | 証明書の認証レベル | 3段階の違いと用途 |
| CT(Certificate Transparency) | 不正証明書の検出 | 公開ログによる透明性確保 |
| ACME | 証明書自動発行(Let's Encrypt) | DV証明書の自動化 |

### S/MIME と PGP の比較

| 項目 | S/MIME | PGP |
|------|--------|-----|
| 信頼モデル | PKI(認証局) | Web of Trust(相互署名) |
| 証明書 | X.509証明書(CA発行) | 公開鍵に対する署名(ユーザ間) |
| 標準化 | IETF(RFC 8551等) | OpenPGP(RFC 4880) |
| 主な用途 | 企業メールの暗号化・署名 | 個人間のメール暗号化・署名 |
| 鍵管理 | CA依存(組織向き) | 自己管理(個人向き) |
| 暗号化対象 | メール本文+添付 | メール、ファイル、ディスク |

### 長期署名フォーマット比較

| フォーマット | 対象 | 標準 | 特徴 |
|------------|------|------|------|
| CAdES | バイナリデータ | ETSI EN 319 122 | CMS(PKCS#7)ベース |
| XAdES | XMLデータ | ETSI EN 319 132 | XML署名の拡張 |
| PAdES | PDF文書 | ETSI EN 319 142 | PDF内蔵型、最も普及 |
| JAdES | JSONデータ | ETSI EN 319 182 | JWS拡張、API向け |

### 試験対策：出題テーマ別の重要度

| テーマ | 午前II | 午後 | 重要キーワード |
|--------|-------|------|--------------|
| 共通鍵暗号(AES) | ★★★ | ★★ | SPN構造、鍵長、CRYPTREC |
| 暗号利用モード | ★★★ | ★★★ | ECBの危険性、GCM/AEAD、CBC |
| 公開鍵暗号(RSA/ECC) | ★★★ | ★★ | 素因数分解、楕円曲線、鍵長比較 |
| DH鍵交換/PFS | ★★ | ★★★ | ECDHE、前方秘匿性、TLS 1.3 |
| ハッシュ関数 | ★★★ | ★★ | SHA-2/SHA-3、衝突耐性、MD5危険性 |
| MAC(HMAC/CMAC) | ★★ | ★★ | 改ざん検知、署名との違い |
| デジタル署名 | ★★★ | ★★★ | 署名生成/検証手順、否認防止 |
| PKI・証明書 | ★★★ | ★★★ | CA階層、CRL/OCSP、証明書チェーン検証 |
| 長期署名 | ★★ | ★★ | CAdES/PAdES、タイムスタンプ |
| S/MIME・PGP | ★★ | ★ | PKI vs Web of Trust、信頼モデル |
| ハイブリッド暗号 | ★★ | ★★★ | TLSハンドシェイク、鍵交換+暗号化 |
| 耐量子暗号 | ★ | ★ | 格子暗号、PQC、NIST標準化動向 |
