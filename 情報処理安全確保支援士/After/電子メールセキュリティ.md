# DKIM・PGP・S/MIME・SMTP over TLS・DMARC・スパム対策・OP25Bを体系的に整理

## はじめに

2025年10月のプロジェクトマネージャ試験受験を終え、2026年秋の情報処理安全確保支援士に向けて勉強中です。
本記事を含めた各知識のインデックスや学習の道のりについては、「[情報処理安全確保支援士への道のり(随時更新中)](https://qiita.com/teppei19980914/items/a25279a17b210d6ed9f4)」をご参照ください。
**本記事は学習した内容を記載しています。**

## 該当問題

[情報セキュリティスペシャリスト平成21年春期 午前Ⅱ 問4](https://www.sc-siken.com/kakomon/21_haru/am2_4.html)
[情報セキュリティスペシャリスト平成24年秋期 午前Ⅱ 問5](https://www.sc-siken.com/kakomon/24_aki/am2_5.html)
[情報セキュリティスペシャリスト平成27年春期 午前Ⅱ 問2](https://www.sc-siken.com/kakomon/27_haru/am2_2.html)
[情報セキュリティスペシャリスト平成28年春期 午前Ⅱ 問13](https://www.sc-siken.com/kakomon/28_haru/am2_13.html)
[情報処理安全確保支援士令和元年秋期 午前Ⅱ 問12](https://www.sc-siken.com/kakomon/01_aki/am2_12.html)
[情報処理安全確保支援士令和6年秋期 午前Ⅱ 問10](https://www.sc-siken.com/kakomon/06_aki/am2_10.html)

## メール配送アーキテクチャ

電子メールの配送は複数のコンポーネントが連携して動作します。午後問題ではメールの流れを正確に理解していることが前提となるため、各構成要素の役割を把握する必要があります。

### メール配送の構成要素

| コンポーネント | 正式名称 | 役割 | 具体例 |
|-------------|---------|------|-------|
| **MUA** | Mail User Agent | メールの作成・閲覧を行うクライアント | Outlook、Thunderbird、Gmail(Web) |
| **MSA** | Mail Submission Agent | MUAからのメールを受け付け、認証を行う | ポート587で受信、SMTP AUTH実施 |
| **MTA** | Mail Transfer Agent | メールを中継・転送する | Postfix、sendmail、Exchange |
| **MDA** | Mail Delivery Agent | メールをユーザのメールボックスに配送する | procmail、Dovecot LDA |
| **MRA** | Mail Retrieval Agent | メールボックスからメールを取り出す | POP3/IMAPサーバ |

### メール配送の流れ

```
送信者MUA → MSA(587) → 送信側MTA → [インターネット] → 受信側MTA(25) → MDA → メールボックス → MRA(POP3/IMAP) → 受信者MUA
```

1. 送信者のMUAがMSAにメールを送信します（ポート587、SMTP AUTH必須）
2. MSAがMTAにメールを渡します
3. 送信側MTAがDNSのMXレコードを参照し、受信側MTAにSMTPで配送します（ポート25）
4. 受信側MTAがSPF/DKIM/DMARCの検証を実施します
5. MDAがメールをユーザのメールボックスに格納します
6. 受信者のMUAがMRA経由でメールを取得します（POP3S:995 / IMAPS:993）

### Envelope-FromとHeader-Fromの違い（試験頻出）

メールには2種類の「送信者アドレス」が存在します。この区別はSPF/DKIM/DMARCの理解に不可欠です。

| 項目 | Envelope-From | Header-From |
|------|-------------|------------|
| **別名** | MAIL FROM、Return-Path | RFC 5322 From |
| **設定場所** | SMTPプロトコルのMAIL FROMコマンド | メールヘッダのFromフィールド |
| **表示** | 通常は受信者に表示されない | 受信者のメールクライアントに表示される |
| **用途** | バウンスメール（エラー通知）の返送先 | 受信者が見る「差出人」 |
| **認証技術** | **SPF**がこのアドレスのドメインを検証 | **DMARC**がこのアドレスとの整合性を検証 |
| **偽装の容易さ** | MTAが設定するため比較的困難 | 送信者が自由に設定可能（偽装容易） |

SPFはEnvelope-Fromのドメインを検証しますが、受信者が実際に目にするHeader-Fromは検証しません。この「隙間」をDMARCのAlignment検証が埋めます。

### MXレコードとメール配送

MTA間のメール配送では、DNSの**MXレコード（Mail Exchanger Record）**を参照します。

```
example.jp.  IN  MX  10  mail1.example.jp.
example.jp.  IN  MX  20  mail2.example.jp.
```

- 優先度の値が**小さいほど優先**されます
- 優先度10のサーバが応答しない場合、優先度20のサーバにフォールバックします
- MXレコードがない場合はAレコードにフォールバックします

## 電子メールの脅威と背景(RFC 5322など)

電子メールはもともと「平文通信」が前提で設計されたため、以下の脅威が存在します。

### 電子メールの主要脅威

- 通信経路での盗聴(Sniffing)
- 改ざん(Header/Body tampering)
- From偽装(Sender Spoofing)
- 中間者攻撃(MITM)
- マルウェア添付、フィッシング
- スパムメールによる詐欺/感染拡大

これらを防ぐため、メールセキュリティは **多層構造** で強化される必要があります。

## スパムメール(迷惑メール)

### スパムメールとは

**受信者の同意なく、一方向に大量に送信される電子メール** を指します。

スパムメールが問題となる理由は以下のとおりです。

- マルウェア拡散(例：Emotet)
- フィッシング詐欺(偽ログインページ)
- 業務メールサーバの過負荷
- 企業ブランドの毀損

スパム送信元の多くは **マルウェアに感染した端末(Zombie PC)** が多くを占めます。

### スパム関連の攻撃手法

|攻撃手法|説明|
|--------|------|
|フィッシング|偽装したログインページへ誘導します|
|スピアフィッシング|特定の組織/人物を狙い撃ちします|
|BEC(ビジネスメール詐欺)|取引先を装った送金指示などです|
|Emotetなどのマルウェア添付|添付ファイル/URLで感染します|
|Typosquatting|類似ドメインによる偽サイトです|

## SMTPと宛先ポート番号25番

SMTP(Simple Mail Transfer Protocol)は **電子メールの送信プロトコル** であり、RFC 2821(後継RFC 5321)で定義されています。

### ポート番号の役割

|ポート番号|役割|RFC|
|---------|------|-----|
|**25(SMTP)**|メールサーバ間の配送(MTA間通信)|RFC 5321|
|**587(Submission)**|利用者→ISPのメール送信(認証必須)|RFC 6409|
|**465(SMTPS)**|TLSラップ方式(現在は「サブミッションTLS」)|RFC 8314|

### なぜポート25が問題になるのか

- 認証が不要です
- 暗号化されていないことが多いです
- マルウェアが **直接外部のメールサーバへ送信できてしまいます**

これが **OP25Bが導入される理由** です。

## ISP(Internet Service Provider)

ISPは総務省が定義する **電気通信事業者** であり、インターネット接続/メールサービス/セキュリティ対策を提供します。

ISPの義務(総務省ガイドライン)は以下のとおりです。

- 迷惑メール対策(OP25Bの実施推奨)
- 不正通信の遮断
- 利用者通知/教育
- ログ管理

## OP25B(Outbound Port 25 Blocking)

OP25Bとは、**ISPが利用者端末から外部へのポート25宛の通信を遮断する仕組み** です。

### OP25Bが解決する問題

マルウェアに感染したPCが **ISPのメールサーバを経由せずに世界中へspamを直接送信** することを防止します。

### 利用者はどうやってメールを送信するのか

RFC 6409に基づき **ポート587 + SMTP AUTH(ユーザ認証)** を使用します。

### 試験対策

以下の3つの条件すべてに合致する通信をISP側で遮断します。

* **ISP管理下** の動的IPアドレスから
* ISPのメールサーバを経由せずに **外向き(インターネット方向)** に発信される
* **SMTP** 通信(TCPポート25番)

## DKIM(DomainKeys Identified Mail)

DKIMは、**電子メールに暗号学的署名を付与し、送信ドメインの正当性と改ざん検知を提供する技術** です。

### DKIMが提供するセキュリティ

- **送信ドメイン認証(Sender Authentication)**
- **メッセージ改ざん検知(Integrity)**

### DKIMの処理概要

1. 送信者がメール本文/ヘッダを正規化(Canonicalization)します
2. ハッシュ化した値を秘密鍵で署名します
3. 署名を「DKIM-Signature」ヘッダとして付与します
4. 受信側はDNSから公開鍵を取得し、署名検証を実施します

### DKIM-Signatureフィールド例

```
DKIM-Signature: v=1; a=rsa-sha256; d=example.jp; s=selector1;
 h=From:To:Subject:Date;
 bh=Q2sY9uE...(body-hash);
 b=F7g3sA...(signature)
```

#### 主なタグ一覧

| タグ | 意味 |
|------|-------|
| v | バージョン |
| a | 署名アルゴリズム |
| d | 署名ドメイン |
| s | セレクタ(鍵識別子) |
| h | 署名対象ヘッダ |
| bh | 本文ハッシュ |
| b | 署名値 |

### DNSに公開されるDKIM鍵(TXTレコード)

```
selector1._domainkey.example.jp IN TXT (
 "v=DKIM1; k=rsa; p=MIIBIjANBgkqh..."
)
```

### DKIMの弱点(RFC 6376/RFC 7489)

- **From表示名との一致保証は弱い → DMARCが補完** します
- **メーリングリストによる書き換えで署名が壊れやすい → ARCが補完** します

## PGP(Pretty Good Privacy)／OpenPGP(RFC 4880)

PGPはユーザが公開鍵を交換し合い、**メール本文にエンドツーエンド暗号化と電子署名を付与する方式** です。

### PGPの主要特徴

| 機能 | 説明 |
|------|------|
| 暗号化 | 受信者の公開鍵を使用します |
| 電子署名 | 送信者の秘密鍵を使用します |
| 鍵管理方式 | Web of Trust(分散型) |

### Web of Trustとは

- 中央CAを持たず、ユーザ同士が鍵に署名して信頼を構築します
- 利点：分散型で柔軟です
- 欠点：企業での運用負荷が高いです

## S/MIME(Secure/Multipurpose Internet Mail Extensions)

S/MIMEは **企業向けPKIメールセキュリティ** 技術です。

### S/MIMEの特徴

| 機能 | 説明 |
|--------|---------|
| 暗号化 | CMS(Cryptographic Message Syntax)を利用します |
| 電子署名 | X.509証明書で署名します |
| 鍵管理 | PKI(CAによる証明書管理) |
| 互換性 | 多くのクライアントが標準対応しています |

### PGPとの比較

| 観点 | PGP/OpenPGP | S/MIME |
|------|----------------|---------|
| 鍵管理 | Web of Trust | PKI(CAが発行) |
| ユーザ対象 | 個人利用 | 組織利用 |
| 運用性 | ユーザ管理 | 組織的な証明書管理 |
| 国際標準 | RFC 4880 | RFC 5751 |

## SMTP over TLS(RFC 3207)

SMTPをTLSで暗号化し、通信経路上での盗聴/改ざんを防ぐ仕組みです。

### STARTTLSの流れ

1. SMTPで平文接続します
2. クライアントが `STARTTLS` を送信します
3. TLSハンドシェイク開始します
4. 暗号化チャネル確立後、SMTPを継続します

### SMTP over TLSが提供するセキュリティ

| 項目 | 説明 |
|-------|------|
| 暗号化 | 経路の盗聴防止 |
| 改ざん検知 | TLSのMACにより検知 |
| サーバ認証 | TLS証明書で正当性を保証 |

注意：メール本文は転送の途中で復号されるため、**エンドツーエンド暗号化ではありません**。

## メール認証技術(SPF/DKIM/DMARC/ARC)

### SPF(Sender Policy Framework)RFC 7208

DNSに「正当な送信元IPアドレス」を登録し、**サーバなりすましを検出** する技術です。

#### SPFレコードの構文

SPFレコードはDNSのTXTレコードとして公開します。

```
example.jp.  IN  TXT  "v=spf1 ip4:192.0.2.0/24 include:_spf.google.com -all"
```

#### SPFのメカニズム（試験頻出）

| メカニズム | 説明 | 例 |
|----------|------|-----|
| **ip4** | 指定したIPv4アドレス/ネットワークを許可 | `ip4:192.0.2.1` |
| **ip6** | 指定したIPv6アドレス/ネットワークを許可 | `ip6:2001:db8::/32` |
| **a** | ドメインのAレコードのIPを許可 | `a:mail.example.jp` |
| **mx** | ドメインのMXレコードのIPを許可 | `mx` |
| **include** | 他ドメインのSPFレコードを参照 | `include:_spf.google.com` |
| **all** | 上記以外のすべてに適用（末尾に記述） | `-all` |
| **exists** | 指定ドメインのAレコード存在で判定 | `exists:%{i}.spf.example.jp` |
| **redirect** | 他ドメインのSPFレコードに委任 | `redirect=_spf.example.com` |

#### SPFのクオリファイア

| クオリファイア | 意味 | 結果 | 推奨場面 |
|-------------|------|------|---------|
| **+**（Pass） | 許可（デフォルト、省略可） | 認証成功 | 正当な送信元 |
| **-**（Fail） | 明示的な拒否 | 認証失敗 | 最終的な運用段階 |
| **~**（SoftFail） | 弱い拒否（疑わしい） | 認証失敗だが受信は可能 | 導入初期・移行期間 |
| **?**（Neutral） | 判定しない | 認証結果なし | テスト段階 |

#### SPFの検証結果

| 結果 | 意味 |
|------|------|
| Pass | 送信元IPがSPFレコードに一致 |
| Fail | 送信元IPが明示的に拒否された |
| SoftFail | 送信元IPが弱い拒否に該当 |
| Neutral | SPFレコードでは判定しない |
| None | SPFレコードが存在しない |
| TempError | DNS参照の一時的なエラー |
| PermError | SPFレコードの構文エラー |

#### SPFの制限事項

- **DNS参照回数の上限は10回**です（include/a/mx/redirect等のDNS参照が対象、ip4/ip6は含まない）
- 超過すると**PermError**となり認証失敗します
- **メール転送（Forward）ではSPFが失敗**します（送信元IPが転送サーバのIPに変わるため）
- Envelope-Fromのドメインのみを検証するため、**Header-Fromの偽装は検知できません**（DMARCで補完）

### DMARC(Domain-based Message Authentication, Reporting, and Conformance)

DMARCは、SPFおよびDKIMの検証結果と **Fromドメインの整合性(Alignment)** を基準とした受信側ポリシーを定義するメール認証技術です。

#### DMARCの目的

1. **なりすまし(From偽装)を検知/防止** します
2. **メール改ざんの発見** を行います
3. **SPF/DKIMの運用強化** を行います
4. **レポートによる可視化(RUA/RUF)** を行います

#### DMARCの適用条件

DMARCはFromヘッダのドメイン(Header-From)を基準としてSPF/DKIMの結果を参照します。

- **SPF Alignment** → Envelope-FromとHeader-Fromが同一組織(Organizational Domain)
- **DKIM Alignment** → DKIM署名のd=ドメインとHeader-Fromが同一組織

#### DMARCポリシー(p=)の詳細

DMARCのポリシーには以下の3種類です(RFC 7489 Section 6.3)。

| ポリシー | 意味 | 効果 |
|---------|------|-------|
| `p=none` | 監視モード(何もしない) | 認証結果はログ化されるが配送は通常どおりです |
| `p=quarantine` | 隔離 | 迷惑メールフォルダへ移動などの弱い拒否です |
| `p=reject` | 拒否 | 認証失敗メールをSMTPレベルで拒否します |

##### none(監視モード)

- SPF/DKIMの整合性を可視化する「導入初期」に利用します
- RUAレポートで送信元の状況を把握し、誤検知がないかを確認します

##### quarantine(隔離)

- 一部の失敗メールを迷惑メールへ振り分けます
- 正当なメールが誤検知される場合に備えて「段階的導入」で利用します

##### reject(拒否)

- 最も強力な保護です
- 認証失敗メールを配送前に拒否するため、なりすまし防止に極めて有効です
- 正当な送信がすべてSPF/DKIMと整合する状態になってから適用します

#### Alignment(整合性)とは

DMARCはSPF/DKIMが成功しても「Fromドメインと一致していなければ成功扱いになりません」。

例：

- SPFの検証はmail.example.netが成功
- Header-Fromはexample.jp
→ **Alignment不一致 → DMARC失敗**

これは「From偽装」の本質的対策です。

#### DMARCレポート(RUA/RUF)

DMARCはレポート送信先をDNSで指定できます。

```
rua=mailto:dmarc-report@example.jp
ruf=mailto:dmarc-forensic@example.jp
```

- **RUA(Aggregate Report)** → 集計レポート
- **RUF(Forensic Report)** → 失敗時のエビデンス(原文含む場合あり)

運用者はレポート分析によって、以下を把握できます。

- 自社ドメインを悪用する送信元
- SPF/DKIMの誤設定
- メーリングリストや転送経路での破損

#### メール転送とDMARCの課題

メール転送(Forward)では以下の問題が発生します。

1. **SPFが失敗します(送信元IPが変わるため)**
2. **DKIMが破損します(書き換えによる)**

これに対応する技術は以下のとおりです。

- **ARC(Authenticated Received Chain)RFC 8617**
- 転送元が「署名連鎖(Chain)」を付与し、受信者が整合性を判断できます

#### DMARCとSPF/DKIMの役割関係

| 技術 | 目的 | 限界 |
|------|------|------|
| SPF | メールを送ったサーバIPが正当か | 転送で失敗しやすいです |
| DKIM | 電子署名で改ざん防止 | メール加工で署名破損します |
| DMARC | FromとSPF/DKIMの整合性を検証し受信側ポリシーを決定 | SPF/DKIMが前提です |

DMARCは **SPF/DKIMを統合し、メール正当性を判断する最終ゲート** です。

### ARC(Authenticated Received Chain)RFC 8617

メーリングリスト転送などでDKIMが壊れても、**署名チェーンを保証する仕組み** です。

#### ARCが解決する問題

メール転送やメーリングリストでは以下の問題が発生します。

- **SPF失敗**：転送サーバのIPアドレスが元の送信ドメインのSPFレコードに含まれない
- **DKIM失敗**：メーリングリストがSubjectやBodyを書き換えると署名が破損する
- **DMARC失敗**：SPF/DKIM双方が失敗するとDMARCも失敗し、正当なメールが拒否される

ARCは転送経路の各中継者が認証結果を署名付きで記録し、受信者が「転送前は正当だった」ことを確認できるようにします。

#### ARCのヘッダ構成（3つのヘッダセット）

ARCは中継のたびに以下の3つのヘッダをセット（i=1, i=2, ...）で付与します。

| ヘッダ | 正式名称 | 役割 |
|-------|---------|------|
| **AAR** | ARC-Authentication-Results | その中継点でのSPF/DKIM/DMARC認証結果を記録 |
| **AMS** | ARC-Message-Signature | DKIMと同様の形式でメッセージに署名 |
| **AS** | ARC-Seal | AARとAMSの完全性を保証する署名（チェーンの封印） |

#### ARC処理フロー

1. 中継サーバがメールを受信し、SPF/DKIM/DMARCの認証結果を確認します
2. 認証結果を**AAR**ヘッダに記録します（`i=1`）
3. メッセージ全体に**AMS**で署名します（`i=1`）
4. AAR + AMSの完全性を**AS**で封印します（`i=1`）
5. 次の中継サーバが同じ手順を`i=2`で繰り返します
6. 最終受信者は**ASチェーンの完全性を検証**し、転送前の認証結果を信頼するか判断します

#### ARCのcv（Chain Validation）タグ

ASヘッダにはチェーンの検証状態を示す`cv`タグが含まれます。

| cv値 | 意味 |
|------|------|
| **none** | 最初のARC署名（i=1）で、前のチェーンがない |
| **pass** | 前のARCチェーンの検証に成功 |
| **fail** | 前のARCチェーンの検証に失敗（チェーンが壊れている） |

## MTA-STS / DANE / BIMI（新しいメールセキュリティ標準）

### MTA-STS（SMTP MTA Strict Transport Security）RFC 8461

#### MTA-STSとは

MTA-STSは、受信側ドメインが**SMTP通信にTLSを強制**することを宣言する仕組みです。STARTTLSのダウングレード攻撃を防止します。

#### STARTTLSの問題点

STARTTLSは「オポチュニスティック（日和見）暗号化」であり、以下の脆弱性があります。

- 中間者がSTARTTLS応答を削除すると**平文にフォールバック**してしまう
- 送信側MTAはTLS必須かどうかを事前に知る手段がない

#### MTA-STSの仕組み

1. 受信側ドメインがDNSに `_mta-sts.example.jp` のTXTレコードを公開します
2. HTTPS上で `https://mta-sts.example.jp/.well-known/mta-sts.txt` にポリシーファイルを配置します
3. 送信側MTAがポリシーを取得し、**TLSが確立できない場合はメール送信を中止**します

#### MTA-STSポリシーのモード

| モード | 動作 |
|-------|------|
| **enforce** | TLS必須。接続できなければ配送を拒否 |
| **testing** | TLS失敗時もメールは配送するがレポートを送信 |
| **none** | ポリシー無効化 |

#### SMTP TLS Reporting（TLSRPT）RFC 8460

MTA-STSと併用し、TLS接続の成功/失敗レポートを送信側から受信側に送信する仕組みです。

```
_smtp._tls.example.jp.  IN  TXT  "v=TLSRPTv1; rua=mailto:tlsrpt@example.jp"
```

### DANE（DNS-based Authentication of Named Entities）RFC 7672

#### DANEとは

DANEは**DNSSECで保護されたDNSにTLS証明書情報（TLSAレコード）を公開**し、中間者攻撃や不正な証明書を防ぐ仕組みです。

#### MTA-STSとDANEの比較

| 項目 | MTA-STS | DANE |
|------|---------|------|
| 依存技術 | HTTPS + DNS | **DNSSEC** + DNS |
| 証明書検証 | 通常のCA検証 | TLSAレコードで直接検証 |
| 導入の容易さ | 比較的容易 | DNSSEC導入が前提で困難 |
| 普及状況 | Gmail等が対応 | 欧州で普及（.nl等） |
| 標準化 | RFC 8461 | RFC 7672 |

### BIMI（Brand Indicators for Message Identification）

#### BIMIとは

BIMIは、**送信ドメインのブランドロゴをメールクライアント上に表示**する仕組みです。DMARCの`p=quarantine`以上が前提となります。

#### BIMIの導入条件

1. **DMARC**が`p=quarantine`または`p=reject`で運用されていること
2. **VMC（Verified Mark Certificate）**を認証局から取得すること
3. DNSにBIMIレコードを公開すること

```
default._bimi.example.jp.  IN  TXT  "v=BIMI1; l=https://example.jp/logo.svg; a=https://example.jp/vmc.pem"
```

#### BIMIのセキュリティ上の意義

- 受信者がメールの正当性を**視覚的に判断**できます
- DMARC運用の強化インセンティブとなります
- フィッシングメールとの区別が容易になります

## スパムメール対策技術

### 送信ドメイン認証

#### SPF(Sender Policy Framework)

**DNSに「送信を許可するメールサーバ」を登録する仕組みです。**

#### DKIM(DomainKeys Identified Mail)

**送信ドメインによる電子署名を付与し、改ざん/なりすましを検知します。**

#### DMARC(Domain-based Message Authentication, Reporting & Conformance)

SPF/DKIMの結果に基づく **受信側の拒否ルール** を定義しています。

### その他のスパム対策

#### ブラックリスト方式(RBL：Realtime Blackhole List)

悪意のあるIPアドレス/ドメインを登録し拒否します。

#### ホワイトリスト方式

信頼できる相手のみ受信を許可します。

#### Content Filter(内容解析)

- ベイズ推定
- 機械学習
- URL評価(ブラックリスト参照)

#### SMTP AUTH(認証)

Submission(587)で必須です。ID/パスワードで本人性を確認します。

#### グレイリスティング（Greylisting）

初回のSMTP接続を一時的に拒否（450応答）し、**一定時間後に再送されたメールのみ受信する方式**です。

- 正規のMTAはRFCに従い再送するため、一定時間後に配送されます
- スパム送信ツールは再送しないことが多いため、スパムを排除できます
- **欠点**：正規メールにも遅延が発生します（初回のみ）

#### Tarpitting（タールピット）

SMTP応答を**意図的に遅延させる**手法です。

- 大量送信を行うスパマーのリソースを消費させます
- RCPT TOコマンドに対して数秒〜数十秒の遅延を挿入します
- 正規の送信者は1通のみのため影響が小さく、大量送信者に効果的です

#### S25R（Selective SMTP Rejection）

送信元IPアドレスの**逆引きホスト名のパターン**でスパムを判定する方式です。

- 動的IPアドレス特有の命名パターン（例：`dhcp-192-168-1-1.isp.example.net`）を正規表現で検出します
- OP25Bと組み合わせて効果を発揮します

#### SPF/DKIM/DMARCに基づくフィルタリング

| 認証結果 | 推奨アクション |
|---------|-------------|
| DMARC pass | 通常配送 |
| DMARC fail + p=reject | 受信拒否 |
| DMARC fail + p=quarantine | 迷惑メールフォルダへ隔離 |
| DMARC fail + p=none | 通常配送（ログ記録のみ） |

#### スパム対策の多層防御

効果的なスパム対策は単一の技術ではなく、以下の多層構造で実現します。

| 層 | 技術 | 検出対象 |
|----|------|---------|
| **接続層** | OP25B、RBL/DNSBL、S25R、グレイリスティング | 送信元IP/接続パターン |
| **プロトコル層** | SMTP AUTH、tarpitting | SMTP通信の正当性 |
| **認証層** | SPF、DKIM、DMARC、ARC | 送信ドメインの正当性 |
| **内容層** | ベイジアンフィルタ、機械学習、URL評価 | メール本文・ヘッダの特徴 |
| **添付層** | サンドボックス、CDR、拡張子フィルタ | 添付ファイルの危険性 |

## メールの暗号化技術の比較(体系まとめ)

| 技術 | 暗号化範囲 | 認証方式 | 主用途 |
|------|-------------|-----------|-----------|
| PGP | エンドツーエンド | Web of Trust | 個人利用 |
| S/MIME | エンドツーエンド | PKI | 企業利用 |
| SMTP over TLS | 経路(Hop-by-hop) | TLS証明書 | 通信経路暗号化 |

## メールヘッダ解析（午後問題で頻出）

午後問題ではメールヘッダを読み解いてインシデントの原因を特定する問題が出題されます。主要なヘッダフィールドの意味と読み方を理解する必要があります。

### Receivedヘッダ

メールが中継されるたびにMTAが**先頭に追加**するヘッダです。下から上に読むことで配送経路を追跡できます。

```
Received: from mail-out.example.net (mail-out.example.net [203.0.113.10])
        by mx.example.jp (Postfix) with ESMTPS id ABC123
        for <user@example.jp>; Tue, 25 Feb 2026 10:30:00 +0900
```

#### Receivedヘッダの読み方

| 要素 | 意味 |
|------|------|
| **from** | 送信元のホスト名（HELO/EHLOで名乗った名前とDNS逆引き結果） |
| **by** | 受信したMTAのホスト名 |
| **with** | 使用したプロトコル（SMTP / ESMTP / ESMTPS等） |
| **id** | メッセージのキューID（ログ追跡に使用） |
| **for** | 宛先アドレス |
| **日時** | 受信日時（タイムゾーン付き） |

#### Receivedヘッダの分析ポイント

- **fromの括弧内IPアドレス**と**名乗ったホスト名**の不一致は、なりすましの可能性を示します
- **ESMTPSの有無**でTLS暗号化の有無を確認できます
- **時刻の不自然なジャンプ**はメールキュー遅延やサーバ問題を示唆します
- **最下部のReceivedヘッダ**が最初の送信元であり、ここが偽装されている可能性を考慮します

### Authentication-Resultsヘッダ（RFC 8601）

受信側MTAがSPF/DKIM/DMARCの認証結果を記録するヘッダです。

```
Authentication-Results: mx.example.jp;
  spf=pass (sender IP is 192.0.2.1) smtp.mailfrom=sender@example.net;
  dkim=pass header.d=example.net header.s=selector1;
  dmarc=pass (p=reject dis=none) header.from=example.net
```

#### 認証結果の見方

| フィールド | 検証対象 | 主な結果値 |
|----------|---------|----------|
| **spf=** | Envelope-Fromドメインの送信元IP | pass / fail / softfail / none |
| **dkim=** | DKIM署名の検証 | pass / fail / none |
| **dmarc=** | Fromドメインとの整合性 | pass / fail / none |

#### インシデント分析での活用

| 状況 | 考えられる原因 |
|------|-------------|
| spf=fail, dkim=pass, dmarc=pass | メール転送によるSPF失敗（DKIM Alignmentで救済） |
| spf=pass, dkim=fail, dmarc=pass | メーリングリストによるDKIM破損（SPF Alignmentで救済） |
| spf=fail, dkim=fail, dmarc=fail | なりすましメールの可能性が高い |
| spf=none, dkim=none, dmarc=none | 送信ドメインが認証技術を未導入 |

### その他の重要なメールヘッダ

| ヘッダ | 説明 | セキュリティ上の意義 |
|-------|------|-------------------|
| **Return-Path** | バウンスメールの返送先（Envelope-From） | SPFの検証対象ドメイン |
| **Message-ID** | メールの一意識別子 | ログ追跡に使用 |
| **X-Mailer / User-Agent** | 送信に使用したメールクライアント | 攻撃ツールの特定に活用 |
| **X-Originating-IP** | 送信者の元のIPアドレス | Webメール経由の場合に記録される |
| **Reply-To** | 返信先アドレス | Fromと異なる場合はフィッシングの可能性 |
| **Content-Type** | メール本文のMIMEタイプ | 不審な添付ファイル形式の検出 |

## 周辺知識

### MIME(Multipurpose Internet Mail Extensions)

- 画像、PDF、添付の送信を可能にする仕組みです
- S/MIMEもMIME形式で表現されます

### Base64

バイナリデータをASCII化する方式です。メールで暗号化データや添付が扱えるようになります。

### POP3S/IMAPS(TLS受信)

| プロトコル | ポート | 概要 |
|------------|--------|--------|
| POP3S | 995 | TLSによる暗号化受信 |
| IMAPS | 993 | TLSによる暗号化受信 |

### PKIと証明書失効

S/MIMEやTLSでは、証明書失効確認として、下記が利用されます。

- **CRL(Certificate Revocation List)**
- **OCSP(Online Certificate Status Protocol)**

### メール添付ファイルのセキュリティ

#### 添付ファイルを悪用した攻撃手法

| 手法 | 説明 |
|------|------|
| **マクロ付き文書** | Word/Excelのマクロでマルウェアをダウンロード・実行（Emotet等） |
| **実行ファイル偽装** | 二重拡張子（report.pdf.exe）やRLO（Right-to-Left Override）で偽装 |
| **パスワード付きZIP** | セキュリティ製品のスキャンを回避するために暗号化ZIPで添付 |
| **HTMLファイル添付** | ローカルでHTMLを開かせ、フィッシングサイトへ誘導 |
| **ISOファイル/ショートカット** | OS標準機能でマウントされる形式を悪用（Mark of the Web回避） |

#### 添付ファイル対策

| 対策 | 説明 |
|------|------|
| **サンドボックス検査** | 添付ファイルを隔離環境で実行し、振る舞いを分析（FireEye、Cuckoo等） |
| **添付ファイル無害化（CDR）** | Content Disarm & Reconstruction。マクロ・スクリプトを除去してファイルを再構成 |
| **拡張子フィルタリング** | 実行可能ファイル（.exe, .scr, .bat等）の添付をブロック |
| **アンチウイルススキャン** | シグネチャベースおよびヒューリスティックスキャン |
| **メールゲートウェイ** | 受信時に添付ファイルを検査・フィルタリングする専用アプライアンス |

#### PPAP問題と代替手段

**PPAP**とは、以下の手順でファイルを送付する慣行です。

- **P**asswordつきZIPファイルを送ります
- **P**asswordを送ります
- **A**ん号化します
- **P**rotocolです

##### PPAPの問題点

- パスワードとZIPが**同一経路（メール）**で送信されるため、盗聴対策として無意味です
- **パスワード付きZIPはセキュリティ製品がスキャンできない**ため、マルウェア検知を回避されます
- 2020年に内閣府が廃止を宣言し、民間企業にも廃止が広がっています

##### PPAPの代替手段

| 代替手段 | 説明 |
|---------|------|
| **クラウドストレージ共有** | Box、Google Drive、OneDrive等でリンク共有（アクセス制御付き） |
| **S/MIME暗号化** | メール本文ごとエンドツーエンド暗号化 |
| **ファイル転送サービス** | 専用のセキュアファイル転送サービスを利用 |
| **チャットツール** | Slack、Teams等の暗号化されたチャネルで共有 |

### POP3とIMAPの違い

| 項目 | POP3 | IMAP |
|------|------|------|
| 正式名称 | Post Office Protocol v3 | Internet Message Access Protocol |
| メール保存場所 | クライアントにダウンロード | サーバ上に保持 |
| 複数端末での利用 | 困難（ダウンロード済みは他端末で見られない） | 容易（サーバ同期） |
| オフライン利用 | ○（ダウンロード後） | △（キャッシュ依存） |
| サーバ容量 | 節約可能 | サーバ容量を消費 |
| ポート番号 | 110（平文）/ 995（TLS） | 143（平文）/ 993（TLS） |

### メールセキュリティゲートウェイ（SEG）

メールセキュリティゲートウェイは、組織のメールサーバの前段に配置され、以下の機能を提供します。

- **スパムフィルタリング**：送信ドメイン認証、ベイジアンフィルタ、機械学習
- **マルウェア検査**：シグネチャスキャン、サンドボックス解析
- **添付ファイル無害化**：CDR（Content Disarm & Reconstruction）
- **URLリライティング**：メール内URLをプロキシ経由に書き換え、クリック時に安全性を検査
- **DLP（情報漏えい防止）**：機密情報を含むメールの送信をブロック
- **暗号化強制**：TLSやS/MIMEによる暗号化を自動適用

## まとめ表（横断比較・出題頻度）

### 送信ドメイン認証技術の比較（試験最頻出）

| 技術 | 検証対象 | 検証方法 | DNSレコード | 保護範囲 | 限界 |
|------|---------|---------|-----------|---------|------|
| **SPF** | Envelope-Fromの送信元IP | DNS TXTレコードと送信元IPの照合 | TXTレコード | サーバなりすまし防止 | 転送で失敗、Header-From未検証 |
| **DKIM** | メール本文+ヘッダの完全性 | 公開鍵による電子署名検証 | TXTレコード（_domainkey） | 改ざん検知+ドメイン認証 | メーリングリスト等で署名破損 |
| **DMARC** | Header-Fromとの整合性 | SPF/DKIM結果+Alignment検証 | TXTレコード（_dmarc） | From偽装防止+ポリシー制御 | SPF/DKIMが前提 |
| **ARC** | 転送経路の認証チェーン | 中継者ごとの署名チェーン検証 | なし（ヘッダに記録） | 転送時の認証結果保存 | 受信者の信頼判断に依存 |

### メール暗号化技術の比較

| 技術 | 暗号化範囲 | 鍵管理方式 | 認証 | 主な用途 | 標準 |
|------|----------|----------|------|---------|------|
| **PGP/OpenPGP** | エンドツーエンド | Web of Trust（分散型） | 電子署名 | 個人間の秘匿通信 | RFC 4880 |
| **S/MIME** | エンドツーエンド | PKI（CA発行証明書） | X.509証明書 | 企業メールセキュリティ | RFC 5751 |
| **SMTP over TLS** | 経路（Hop-by-hop） | TLS証明書 | サーバ認証 | MTA間通信の暗号化 | RFC 3207 |
| **MTA-STS** | 経路（TLS強制） | TLS証明書 + HTTPSポリシー | サーバ認証 | TLSダウングレード防止 | RFC 8461 |
| **DANE** | 経路（TLS検証強化） | DNSSEC + TLSAレコード | 証明書のDNS検証 | 不正証明書の排除 | RFC 7672 |

### メール関連プロトコルとポート番号

| プロトコル | ポート番号 | 用途 | 暗号化 | 認証 |
|----------|----------|------|-------|------|
| SMTP | 25 | MTA間メール配送 | なし（STARTTLSオプション） | なし |
| Submission | 587 | MUA→MSAメール送信 | STARTTLS | SMTP AUTH必須 |
| SMTPS | 465 | MUA→MSAメール送信（TLSラップ） | TLS（暗黙的） | SMTP AUTH |
| POP3 | 110 | メール受信（ダウンロード） | なし | ユーザ認証 |
| POP3S | 995 | メール受信（TLS） | TLS | ユーザ認証 |
| IMAP | 143 | メール受信（サーバ保持） | なし（STARTTLSオプション） | ユーザ認証 |
| IMAPS | 993 | メール受信（TLS） | TLS | ユーザ認証 |

### メール配送コンポーネントの役割

| コンポーネント | 役割 | セキュリティ機能 | 対応プロトコル |
|-------------|------|---------------|-------------|
| **MUA** | メール作成・閲覧 | S/MIME署名/暗号化 | SMTP/POP3/IMAP |
| **MSA** | メール受付・認証 | SMTP AUTH、TLS | Submission(587) |
| **MTA** | メール中継・転送 | SPF/DKIM/DMARC検証、TLS | SMTP(25) |
| **MDA** | メールボックスへ配送 | スパムフィルタ連携 | ローカル配送 |
| **MRA** | メール取り出し | TLS暗号化 | POP3S/IMAPS |

### Envelope-From / Header-From / DKIM d= の対応関係

| アドレス | 設定者 | 検証技術 | DMARC Alignment |
|---------|-------|---------|----------------|
| **Envelope-From** | 送信MTA | **SPF** | SPF Alignment |
| **Header-From** | 送信者（偽装可能） | **DMARC**（最終判定） | 基準ドメイン |
| **DKIM d=** | 署名ドメイン | **DKIM** | DKIM Alignment |

### DMARCポリシー段階的導入の推奨ステップ

| 段階 | ポリシー | pct | 目的 | 期間目安 |
|------|---------|-----|------|---------|
| 1 | `p=none` | - | RUAレポートで現状把握 | 1〜3ヶ月 |
| 2 | `p=quarantine` | `pct=10` | 10%のみ隔離して影響確認 | 1〜2ヶ月 |
| 3 | `p=quarantine` | `pct=100` | 全メールを隔離対象に | 1〜2ヶ月 |
| 4 | `p=reject` | `pct=10` | 10%のみ拒否して影響確認 | 1〜2ヶ月 |
| 5 | `p=reject` | `pct=100` | 完全なnりすまし防止 | 恒久運用 |

### スパム対策技術の分類

| 分類 | 技術 | 判定基準 | 長所 | 短所 |
|------|------|---------|------|------|
| **接続制御** | OP25B | ポート番号 | マルウェア直接送信を防止 | ISP側の設定が必要 |
| **接続制御** | RBL/DNSBL | 送信元IP | リアルタイム更新 | 誤登録による誤検知 |
| **接続制御** | S25R | 逆引きホスト名 | 設定が容易 | 正規MTAの誤検知 |
| **接続制御** | グレイリスティング | 再送有無 | 効果的かつシンプル | 初回メールに遅延発生 |
| **認証** | SPF/DKIM/DMARC | ドメイン認証 | なりすまし検知に有効 | 送信側の対応が必要 |
| **内容解析** | ベイジアンフィルタ | メール内容の統計分析 | 学習による精度向上 | 初期学習が必要 |
| **内容解析** | URL評価 | メール内リンク | フィッシング検知に有効 | 短縮URLで回避される |
| **レート制御** | tarpitting | SMTP応答速度 | 大量送信を抑制 | 正規メールにも遅延 |

### メールセキュリティ技術のRFC一覧

| 技術 | RFC | 概要 |
|------|-----|------|
| SMTP | RFC 5321 | メール転送プロトコル |
| メールメッセージ形式 | RFC 5322 | メールヘッダ・本文の形式 |
| MIME | RFC 2045-2049 | マルチメディアメール拡張 |
| Submission | RFC 6409 | メール送信用ポート587 |
| SMTPS | RFC 8314 | TLSによるメール送信 |
| STARTTLS | RFC 3207 | SMTP over TLS |
| SPF | RFC 7208 | 送信元IP認証 |
| DKIM | RFC 6376 | ドメイン署名認証 |
| DMARC | RFC 7489 | ドメイン認証統合ポリシー |
| ARC | RFC 8617 | 転送時の認証チェーン保存 |
| MTA-STS | RFC 8461 | TLS強制ポリシー |
| TLSRPT | RFC 8460 | TLS接続レポート |
| DANE | RFC 7672 | DNSSECベースのTLS検証 |
| Authentication-Results | RFC 8601 | 認証結果ヘッダ |
| S/MIME | RFC 5751 | PKIメール暗号化・署名 |
| OpenPGP | RFC 4880 | 分散型メール暗号化・署名 |

### 出題テーマ別の試験対策重要度

| テーマ | 午前II | 午後I・II | 頻出キーワード |
|-------|--------|----------|-------------|
| SPF（メカニズム・クオリファイア） | ★★★ | ★★★ | TXTレコード、-all、include、DNS参照10回制限 |
| DKIM（署名検証・鍵公開） | ★★★ | ★★★ | セレクタ、DKIM-Signature、bh/b、公開鍵DNS |
| DMARC（Alignment・ポリシー） | ★★★ | ★★★ | p=none/quarantine/reject、RUA/RUF、Alignment |
| ARC（転送時の認証保証） | ★ | ★★ | AAR/AMS/AS、cv=pass、メーリングリスト問題 |
| OP25B | ★★★ | ★★ | ポート25遮断、587+SMTP AUTH、動的IP |
| SMTP/Submissionポート | ★★ | ★★ | 25/587/465、STARTTLS、SMTP AUTH |
| S/MIME vs PGP | ★★ | ★ | PKI vs Web of Trust、エンドツーエンド暗号化 |
| MTA-STS / DANE | ★ | ★ | TLSダウングレード防止、DNSSEC |
| BIMI | ★ | ★ | VMC、DMARC p=quarantine以上が前提 |
| メールヘッダ解析 | ★ | ★★★ | Receivedヘッダ、Authentication-Results、Return-Path |
| Envelope-From vs Header-From | ★★ | ★★★ | MAIL FROM、RFC 5322 From、SPF/DMARC検証対象 |
| メール配送コンポーネント | ★★ | ★★ | MUA/MSA/MTA/MDA/MRA、MXレコード |
| スパム対策技術 | ★★ | ★★ | RBL、ベイジアンフィルタ、グレイリスティング |
| 添付ファイルセキュリティ | ★ | ★★ | サンドボックス、CDR、PPAP廃止 |
| BEC（ビジネスメール詐欺） | ★ | ★★★ | 送金指示偽装、経営者詐称、取引先詐称 |
