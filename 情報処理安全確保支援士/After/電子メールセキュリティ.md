# DKIM・PGP・S/MIME・SMTP over TLS・DMARC・スパム対策・OP25Bを体系的に整理

## はじめに

2025年10月のプロジェクトマネージャ試験受験を終え、2026年秋の情報処理安全確保支援士に向けて勉強中です。
本記事を含めた各知識のインデックスや学習の道のりについては、「[情報処理安全確保支援士への道のり(随時更新中)](https://qiita.com/teppei19980914/items/a25279a17b210d6ed9f4)」をご参照ください。
**本記事は学習した内容を記載しています。**

## 該当問題

[情報セキュリティスペシャリスト平成21年春期 午前Ⅱ 問4](https://www.sc-siken.com/kakomon/21_haru/am2_4.html)
[情報セキュリティスペシャリスト平成24年秋期 午前Ⅱ 問5](https://www.sc-siken.com/kakomon/24_aki/am2_5.html)
[情報セキュリティスペシャリスト平成27年春期 午前Ⅱ 問2](https://www.sc-siken.com/kakomon/27_haru/am2_2.html)
[情報セキュリティスペシャリスト平成28年春期 午前Ⅱ 問13](https://www.sc-siken.com/kakomon/28_haru/am2_13.html)
[情報処理安全確保支援士令和元年秋期 午前Ⅱ 問12](https://www.sc-siken.com/kakomon/01_aki/am2_12.html)
[情報処理安全確保支援士令和6年秋期 午前Ⅱ 問10](https://www.sc-siken.com/kakomon/06_aki/am2_10.html)

## 電子メールの脅威と背景(RFC 5322など)

電子メールはもともと「平文通信」が前提で設計されたため、以下の脅威が存在します。

### 電子メールの主要脅威

- 通信経路での盗聴(Sniffing)
- 改ざん(Header/Body tampering)
- From偽装(Sender Spoofing)
- 中間者攻撃(MITM)
- マルウェア添付、フィッシング
- スパムメールによる詐欺/感染拡大

これらを防ぐため、メールセキュリティは **多層構造** で強化される必要があります。

## スパムメール(迷惑メール)

### スパムメールとは

**受信者の同意なく、一方向に大量に送信される電子メール** を指します。

スパムメールが問題となる理由は以下のとおりです。

- マルウェア拡散(例：Emotet)
- フィッシング詐欺(偽ログインページ)
- 業務メールサーバの過負荷
- 企業ブランドの毀損

スパム送信元の多くは **マルウェアに感染した端末(Zombie PC)** が多くを占めます。

### スパム関連の攻撃手法

|攻撃手法|説明|
|--------|------|
|フィッシング|偽装したログインページへ誘導します|
|スピアフィッシング|特定の組織/人物を狙い撃ちします|
|BEC(ビジネスメール詐欺)|取引先を装った送金指示などです|
|Emotetなどのマルウェア添付|添付ファイル/URLで感染します|
|Typosquatting|類似ドメインによる偽サイトです|

## SMTPと宛先ポート番号25番

SMTP(Simple Mail Transfer Protocol)は **電子メールの送信プロトコル** であり、RFC 2821(後継RFC 5321)で定義されています。

### ポート番号の役割

|ポート番号|役割|RFC|
|---------|------|-----|
|**25(SMTP)**|メールサーバ間の配送(MTA間通信)|RFC 5321|
|**587(Submission)**|利用者→ISPのメール送信(認証必須)|RFC 6409|
|**465(SMTPS)**|TLSラップ方式(現在は「サブミッションTLS」)|RFC 8314|

### なぜポート25が問題になるのか

- 認証が不要です
- 暗号化されていないことが多いです
- マルウェアが **直接外部のメールサーバへ送信できてしまいます**

これが **OP25Bが導入される理由** です。

## ISP(Internet Service Provider)

ISPは総務省が定義する **電気通信事業者** であり、インターネット接続/メールサービス/セキュリティ対策を提供します。

ISPの義務(総務省ガイドライン)は以下のとおりです。

- 迷惑メール対策(OP25Bの実施推奨)
- 不正通信の遮断
- 利用者通知/教育
- ログ管理

## OP25B(Outbound Port 25 Blocking)

OP25Bとは、**ISPが利用者端末から外部へのポート25宛の通信を遮断する仕組み** です。

### OP25Bが解決する問題

マルウェアに感染したPCが **ISPのメールサーバを経由せずに世界中へspamを直接送信** することを防止します。

### 利用者はどうやってメールを送信するのか

RFC 6409に基づき **ポート587 + SMTP AUTH(ユーザ認証)** を使用します。

### 試験対策

以下の3つの条件すべてに合致する通信をISP側で遮断します。

* **ISP管理下** の動的IPアドレスから
* ISPのメールサーバを経由せずに **外向き(インターネット方向)** に発信される
* **SMTP** 通信(TCPポート25番)

## DKIM(DomainKeys Identified Mail)

DKIMは、**電子メールに暗号学的署名を付与し、送信ドメインの正当性と改ざん検知を提供する技術** です。

### DKIMが提供するセキュリティ

- **送信ドメイン認証(Sender Authentication)**
- **メッセージ改ざん検知(Integrity)**

### DKIMの処理概要

1. 送信者がメール本文/ヘッダを正規化(Canonicalization)します
2. ハッシュ化した値を秘密鍵で署名します
3. 署名を「DKIM-Signature」ヘッダとして付与します
4. 受信側はDNSから公開鍵を取得し、署名検証を実施します

### DKIM-Signatureフィールド例

```
DKIM-Signature: v=1; a=rsa-sha256; d=example.jp; s=selector1;
 h=From:To:Subject:Date;
 bh=Q2sY9uE...(body-hash);
 b=F7g3sA...(signature)
```

#### 主なタグ一覧

| タグ | 意味 |
|------|-------|
| v | バージョン |
| a | 署名アルゴリズム |
| d | 署名ドメイン |
| s | セレクタ(鍵識別子) |
| h | 署名対象ヘッダ |
| bh | 本文ハッシュ |
| b | 署名値 |

### DNSに公開されるDKIM鍵(TXTレコード)

```
selector1._domainkey.example.jp IN TXT (
 "v=DKIM1; k=rsa; p=MIIBIjANBgkqh..."
)
```

### DKIMの弱点(RFC 6376/RFC 7489)

- **From表示名との一致保証は弱い → DMARCが補完** します
- **メーリングリストによる書き換えで署名が壊れやすい → ARCが補完** します

## PGP(Pretty Good Privacy)／OpenPGP(RFC 4880)

PGPはユーザが公開鍵を交換し合い、**メール本文にエンドツーエンド暗号化と電子署名を付与する方式** です。

### PGPの主要特徴

| 機能 | 説明 |
|------|------|
| 暗号化 | 受信者の公開鍵を使用します |
| 電子署名 | 送信者の秘密鍵を使用します |
| 鍵管理方式 | Web of Trust(分散型) |

### Web of Trustとは

- 中央CAを持たず、ユーザ同士が鍵に署名して信頼を構築します
- 利点：分散型で柔軟です
- 欠点：企業での運用負荷が高いです

## S/MIME(Secure/Multipurpose Internet Mail Extensions)

S/MIMEは **企業向けPKIメールセキュリティ** 技術です。

### S/MIMEの特徴

| 機能 | 説明 |
|--------|---------|
| 暗号化 | CMS(Cryptographic Message Syntax)を利用します |
| 電子署名 | X.509証明書で署名します |
| 鍵管理 | PKI(CAによる証明書管理) |
| 互換性 | 多くのクライアントが標準対応しています |

### PGPとの比較

| 観点 | PGP/OpenPGP | S/MIME |
|------|----------------|---------|
| 鍵管理 | Web of Trust | PKI(CAが発行) |
| ユーザ対象 | 個人利用 | 組織利用 |
| 運用性 | ユーザ管理 | 組織的な証明書管理 |
| 国際標準 | RFC 4880 | RFC 5751 |

## SMTP over TLS(RFC 3207)

SMTPをTLSで暗号化し、通信経路上での盗聴/改ざんを防ぐ仕組みです。

### STARTTLSの流れ

1. SMTPで平文接続します
2. クライアントが `STARTTLS` を送信します
3. TLSハンドシェイク開始します
4. 暗号化チャネル確立後、SMTPを継続します

### SMTP over TLSが提供するセキュリティ

| 項目 | 説明 |
|-------|------|
| 暗号化 | 経路の盗聴防止 |
| 改ざん検知 | TLSのMACにより検知 |
| サーバ認証 | TLS証明書で正当性を保証 |

注意：メール本文は転送の途中で復号されるため、**エンドツーエンド暗号化ではありません**。

## メール認証技術(SPF/DKIM/DMARC/ARC)

### SPF(Sender Policy Framework)RFC 7208

DNSに「正当な送信元IPアドレス」を登録し、**サーバなりすましを検出** する技術です。

### DMARC(Domain-based Message Authentication, Reporting, and Conformance)

DMARCは、SPFおよびDKIMの検証結果と **Fromドメインの整合性(Alignment)** を基準とした受信側ポリシーを定義するメール認証技術です。

#### DMARCの目的

1. **なりすまし(From偽装)を検知/防止** します
2. **メール改ざんの発見** を行います
3. **SPF/DKIMの運用強化** を行います
4. **レポートによる可視化(RUA/RUF)** を行います

#### DMARCの適用条件

DMARCはFromヘッダのドメイン(Header-From)を基準としてSPF/DKIMの結果を参照します。

- **SPF Alignment** → Envelope-FromとHeader-Fromが同一組織(Organizational Domain)
- **DKIM Alignment** → DKIM署名のd=ドメインとHeader-Fromが同一組織

#### DMARCポリシー(p=)の詳細

DMARCのポリシーには以下の3種類です(RFC 7489 Section 6.3)。

| ポリシー | 意味 | 効果 |
|---------|------|-------|
| `p=none` | 監視モード(何もしない) | 認証結果はログ化されるが配送は通常どおりです |
| `p=quarantine` | 隔離 | 迷惑メールフォルダへ移動などの弱い拒否です |
| `p=reject` | 拒否 | 認証失敗メールをSMTPレベルで拒否します |

##### none(監視モード)

- SPF/DKIMの整合性を可視化する「導入初期」に利用します
- RUAレポートで送信元の状況を把握し、誤検知がないかを確認します

##### quarantine(隔離)

- 一部の失敗メールを迷惑メールへ振り分けます
- 正当なメールが誤検知される場合に備えて「段階的導入」で利用します

##### reject(拒否)

- 最も強力な保護です
- 認証失敗メールを配送前に拒否するため、なりすまし防止に極めて有効です
- 正当な送信がすべてSPF/DKIMと整合する状態になってから適用します

#### Alignment(整合性)とは

DMARCはSPF/DKIMが成功しても「Fromドメインと一致していなければ成功扱いになりません」。

例：

- SPFの検証はmail.example.netが成功
- Header-Fromはexample.jp
→ **Alignment不一致 → DMARC失敗**

これは「From偽装」の本質的対策です。

#### DMARCレポート(RUA/RUF)

DMARCはレポート送信先をDNSで指定できます。

```
rua=mailto:dmarc-report@example.jp
ruf=mailto:dmarc-forensic@example.jp
```

- **RUA(Aggregate Report)** → 集計レポート
- **RUF(Forensic Report)** → 失敗時のエビデンス(原文含む場合あり)

運用者はレポート分析によって、以下を把握できます。

- 自社ドメインを悪用する送信元
- SPF/DKIMの誤設定
- メーリングリストや転送経路での破損

#### メール転送とDMARCの課題

メール転送(Forward)では以下の問題が発生します。

1. **SPFが失敗します(送信元IPが変わるため)**
2. **DKIMが破損します(書き換えによる)**

これに対応する技術は以下のとおりです。

- **ARC(Authenticated Received Chain)RFC 8617**
- 転送元が「署名連鎖(Chain)」を付与し、受信者が整合性を判断できます

#### DMARCとSPF/DKIMの役割関係

| 技術 | 目的 | 限界 |
|------|------|------|
| SPF | メールを送ったサーバIPが正当か | 転送で失敗しやすいです |
| DKIM | 電子署名で改ざん防止 | メール加工で署名破損します |
| DMARC | FromとSPF/DKIMの整合性を検証し受信側ポリシーを決定 | SPF/DKIMが前提です |

DMARCは **SPF/DKIMを統合し、メール正当性を判断する最終ゲート** です。

### ARC(Authenticated Received Chain)RFC 8617

メーリングリスト転送などでDKIMが壊れても、**署名チェーンを保証する仕組み** です。

## スパムメール対策技術

### 送信ドメイン認証

#### SPF(Sender Policy Framework)

**DNSに「送信を許可するメールサーバ」を登録する仕組みです。**

#### DKIM(DomainKeys Identified Mail)

**送信ドメインによる電子署名を付与し、改ざん/なりすましを検知します。**

#### DMARC(Domain-based Message Authentication, Reporting & Conformance)

SPF/DKIMの結果に基づく **受信側の拒否ルール** を定義しています。

### その他のスパム対策

#### ブラックリスト方式(RBL：Realtime Blackhole List)

悪意のあるIPアドレス/ドメインを登録し拒否します。

#### ホワイトリスト方式

信頼できる相手のみ受信を許可します。

#### Content Filter(内容解析)

- ベイズ推定
- 機械学習
- URL評価(ブラックリスト参照)

#### SMTP AUTH(認証)

Submission(587)で必須です。ID/パスワードで本人性を確認します。

## メールの暗号化技術の比較(体系まとめ)

| 技術 | 暗号化範囲 | 認証方式 | 主用途 |
|------|-------------|-----------|-----------|
| PGP | エンドツーエンド | Web of Trust | 個人利用 |
| S/MIME | エンドツーエンド | PKI | 企業利用 |
| SMTP over TLS | 経路(Hop-by-hop) | TLS証明書 | 通信経路暗号化 |

## 周辺知識

### MIME(Multipurpose Internet Mail Extensions)

- 画像、PDF、添付の送信を可能にする仕組みです
- S/MIMEもMIME形式で表現されます

### Base64

バイナリデータをASCII化する方式です。メールで暗号化データや添付が扱えるようになります。

### POP3S/IMAPS(TLS受信)

| プロトコル | ポート | 概要 |
|------------|--------|--------|
| POP3S | 995 | TLSによる暗号化受信 |
| IMAPS | 993 | TLSによる暗号化受信 |

### PKIと証明書失効

S/MIMEやTLSでは、証明書失効確認として、下記が利用されます。

- **CRL(Certificate Revocation List)**
- **OCSP(Online Certificate Status Protocol)**
