# DNS キャッシュポイズニング攻撃とその対策

## はじめに

2025年10月のプロジェクトマネージャ試験受験を終え、2026年春の情報処理安全確保支援士に向けて勉強中です。  
本記事を含めた各知識のインデックスや学習の道のりについては、「[情報処理安全確保支援士への道のり(随時更新中)](https://qiita.com/teppei19980914/items/6411cb70f2937cbefdcc)」をご参照ください。  
**本記事は学習した内容を記載しています。**  

## 該当問題

[情報セキュリティスペシャリスト平成26年秋期 午前Ⅱ 問9](https://www.sc-siken.com/kakomon/26_aki/am2_9.html)  
[情報セキュリティスペシャリスト平成27年春期 午前Ⅱ 問15](https://www.sc-siken.com/kakomon/27_haru/am2_15.html)  
[情報処理安全確保支援士令和4年春期 午前Ⅱ 問13](https://www.sc-siken.com/kakomon/04_haru/am2_13.html)  

## DNS キャッシュポイズニング攻撃とは  

DNS キャッシュポイズニングとは、**DNS リゾルバに偽の DNS 応答をキャッシュさせ、利用者を攻撃者の用意した IP アドレスへ誘導する攻撃**です。  

攻撃に成功すると、下記などの深刻な被害に繋がります。  

- 偽サイトによる認証情報窃取  
- マルウェア配布  
- MITM(中間者攻撃)  
- VPN やメールサーバの偽装  

## DNS が攻撃に弱い理由(RFC5452 が指摘)

DNS の仕様上、以下の条件が一致すれば DNS 応答は“正当”と判定されます。  

- トランザクション ID(16bit = 65,536 通り)  
- 送信元ポート番号  
- クエリ内容(例：www.example.com A レコード)  

これらは暗号化されておらず、攻撃者が大量の偽応答を送ることで、正規応答より先に偽応答が受理されてしまいます。  
(**Kaminsky Attack(2008)** で世界的に問題が顕在化)  

## キャッシュポイズニング攻撃の流れ(試験でよく問われる)

1. 攻撃者が標的リゾルバに対し、大量の偽 DNS 応答を送信  
2. リゾルバが外部 DNS へ問い合わせを行う  
3. 正規応答が返る前に、攻撃者が偽応答を送り込む  
4. トランザクション ID + 送信元ポートが一致すると偽応答がキャッシュ  
5. 利用者は攻撃者サイトへ誘導される  

## DNS キャッシュポイズニング対策(RFC5452/IPA)

### 送信元ポートランダム化  

UDP 53 固定では簡単に予測されるため、**1024〜65535 の範囲からランダムに選択します**(Source Port Randomization)。  
→ 攻撃成功率が大幅に低下。  

### トランザクション ID のランダム化  

高品質な乱数(CSPRNG)を利用して推測困難にします。  

### DNSSEC(DNS Security Extensions)  

DNS 応答に署名(RRSIG)を付与し、公開鍵(DNSKEY)で検証します。  
**偽応答は署名検証で必ず拒否されるため、本質的対策となります。**  

### キャッシュ DNS を外部公開しない(Open Resolver 対策)  

再帰問い合わせを外部に許可すると攻撃対象になるため、**内部ネットワークのみに限定します**。  

### フォワーダの利用  

信頼できる上位 DNS(ISP など)を利用し、リスクを軽減します。  

## DNSSECとは(エビデンス：RFC 4033/4034/4035)

**DNSSEC(Domain Name System Security Extensions)** とは、DNS 応答に **電子署名(公開鍵暗号)を導入し、応答の真正性および完全性を検証可能にする拡張仕様**のことです。  

### DNSSECが提供するセキュリティ特性

| セキュリティ要素 | 提供可否 |
|---|---|
| 応答の真正性 | ○ |
| 応答の完全性 | ○ |
| なりすまし防止 | ○ |
| 通信内容の暗号化 | × |
| 可用性 | × |

**※ DNSSEC は **暗号化技術ではない** **

## DNSSECが必要となった背景

### 従来DNSの根本的弱点

従来の DNS は以下を検証できません。  

- 応答が正規の権威DNSサーバから送られたか
- 応答内容が改ざんされていないか

### 想定される代表的攻撃

- DNSキャッシュポイズニング
- Kaminsky攻撃

これらは **応答の正当性を検証できない設計**に起因します。  
→ DNSSEC は **この根本問題を解決するための仕組み**です。  

## DNSSECの基本構造(鍵とレコード)

### 鍵の種類

| 鍵 | 役割 |
|---|---|
| ZSK(Zone Signing Key) | ゾーン内の各レコードを署名 |
| KSK(Key Signing Key) | ZSK の正当性を署名 |

### DNSSEC関連レコード

| レコード | 役割 |
|---|---|
| DNSKEY | 公開鍵を格納 |
| RRSIG | レコード集合に対する署名 |
| DS | 親ゾーンから子ゾーンへの信頼情報 |
| NSEC/NSEC3 | レコード非存在証明 |

## 信頼の連鎖(Chain of Trust)【最重要】

DNSSEC の核心は **階層構造による信頼連鎖**です。

```
ルートゾーン(.)
↓ DS
TLD(.jp)
↓ DS
example.jp
```

- 親ゾーンは **子ゾーンの KSK のハッシュ値(DS)を保持**
- 上位ゾーンが下位ゾーンの正当性を保証  
→ **1か所でも検証に失敗すると応答は破棄される**  

## DNSSECの検証プロセス(午後頻出)

1. リゾルバが DNS 応答を受信
2. RRSIG を DNSKEY で検証
3. DNSKEY を DS レコードで検証
4. 親ゾーンへ遡って検証
5. ルートまで信頼が連鎖すれば成功

## 「存在しないこと」の証明(NSEC/NSEC3)

### なぜ必要か

攻撃者が **NXDOMAIN 応答を偽装**することを防ぐためです。

### NSEC

- 次に存在する名前を示す
- ゾーンウォーキング可能(弱点)

### NSEC3

- ハッシュ化によりゾーンウォーキングを困難化
- 現在の主流方式

## DNSSECの限界(試験で問われやすい)

| 項目 | DNSSEC |
|---|---|
| キャッシュポイズニング対策 | ○ |
| なりすまし防止 | ○ |
| 通信盗聴対策 | × |
| 通信内容秘匿 | × |

→ 通信の暗号化は **DoH/DoT** が担当します。  

## DNSSECと関連技術の比較

| 技術 | 目的 |
|---|---|
| DNSSEC | 応答の真正性/完全性 |
| DoH | DNS通信の暗号化 |
| DoT | DNS通信の暗号化 |
| TSIG | DNSサーバ間認証 |
| SPF/DKIM/DMARC | メール送信ドメイン認証 |

## 再帰的問合せ(Recursive Query)と反復問合せ(Iterative Query)

DNS の問合せ方式は以下の 2 種類です。  

### 再帰的問合せ(Recursive Query)  

クライアントが DNS サーバに **「最終回答を返してほしい」** と依頼する方式です。  

DNS サーバは下記へ問い合わせ、回答をクライアントに返します。  

1. ルート DNS  
2. TLD DNS  
3. 権威 DNS  

### 反復問合せ(Iterative Query)  

「分かる範囲だけ返してよい」という方式です。  
権威 DNS は通常反復問い合わせのみ対応します。  

例：  

- ルートDNS：TLD の場所だけ知らせる  
- TLD DNS：権威 DNS の場所だけ知らせる  

### 両者の比較

| 項目 | 再帰的問合せ | 反復問合せ |
|------|--------------|------------|
| 調査の主体 | DNS リゾルバ | クライアント |
| クエリ数 | クライアントは 1 回 | クライアントが複数回 |
| 攻撃対象 | ◎(キャッシュ汚染) | × |
| 主な利用場面 | 利用者 PC → DNS | DNS サーバ間通信 |

## 周辺知識(DNS セキュリティ)

### DNS over TLS(DoT)／DNS over HTTPS(DoH)  

DNS クエリ暗号化技術です。    
**キャッシュポイズニング対策ではなく、盗聴対策です。**  

### ゾーン転送(AXFR)  

設定ミスにより**内部ネットワーク情報が漏洩**するため、IP制限や TSIG による認証が必須です。  

### DNS amp攻撃(DNSリフレクタ攻撃) 

脆弱性のある公開DNSキャッシュサーバを踏み台として悪用することで行われる分散型サービス妨害(Distributed Denial of Service: DDoS)攻撃の一種です。  
Open Resolver が攻撃に悪用されます。  
→ **再帰問い合わせを外部に提供しないことが最重要です。**  

#### DNS amp攻撃の手順

攻撃者は、以下の手順で攻撃対象をサービス不能状態に追い込みます。  

1. 攻撃者は、脆弱性のある複数の公開DNSキャッシュサーバに対して、送信元を攻撃対象としたDNSクエリをボットを介して発行  
    → 応答パケットのサイズができるだけ多くなるようにする  
2. クエリを受け取ったDNSキャッシュサーバは、クエリの送信元に設定されている攻撃対象に対して応答パケットを一斉に送信  
3. 大量の応答パケットを受け取った攻撃対象やそれが属するネットワークは過負荷状態となり正常なサービスの提供不可  

**DNS amp攻撃に加担する踏み台にならないためには、利用可能なホストのIPアドレスの範囲を設定するなど、DNSキャッシュサーバが不要なクエリを拒否するようにアクセス制限を施す必要があります。**  
