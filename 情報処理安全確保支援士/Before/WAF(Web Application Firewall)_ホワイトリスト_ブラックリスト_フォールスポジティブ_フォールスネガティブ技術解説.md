# WAF(Web Application Firewall)/ホワイトリスト/ブラックリスト/フォールスポジティブ/フォールスネガティブ技術解説

## はじめに

2025年10月のプロジェクトマネージャ試験受験を終え、2026年春の情報処理安全確保支援士に向けて勉強中です。  
本記事を含めた各知識のインデックスや学習の道のりについては、「[情報処理安全確保支援士への道のり(随時更新中)](https://qiita.com/teppei19980914/items/6411cb70f2937cbefdcc)」をご参照ください。  
**本記事は学習した内容を記載しています。**  

## 該当問題

[情報セキュリティスペシャリスト平成22年秋期 午前Ⅱ 問16](https://www.sc-siken.com/kakomon/22_aki/am2_16.html)  
[情報処理安全確保支援士令和6年秋期 午前Ⅱ 問12](https://www.sc-siken.com/kakomon/06_aki/am2_12.html)  

## WAF(Web Application Firewall)とは  

**WAF(Web Application Firewall)** は、Web アプリケーションを標的とする攻撃(SQL インジェクション、XSS、ディレクトリトラバーサルなど)を検知/防御するための防御装置です。  

### エビデンス  

- **NIST SP 800-95**: WAF はアプリケーション層(Layer 7)脅威に対する防御として推奨  
- **OWASP**: WAF は「脆弱性が残る環境における防御レイヤの 1 つ」と位置づけ  
- **PCI DSS 6.6**: WAF またはコードレビューの実施を義務化  

### WAF の目的  

- Web アプリへの不正リクエストを検知/遮断  
- 攻撃をアプリケーションに届く前にブロック  
- アプリケーションの脆弱性(未修正)を暫定的に保護  

### WAFが防御対象とする代表的攻撃

* SQLインジェクション  
* XSS(クロスサイトスクリプティング)  
* コマンドインジェクション  
* パストラバーサル  
* 不正なファイルアップロード  

**ネットワーク層ではなく、アプリケーション層を守る点が特徴です。**  

## WAF の方式(Blacklist/Whitelist)

WAF のルールは主に **ブラックリスト方式** と **ホワイトリスト方式** の 2 種類で構成されます。  

## ブラックリスト方式(Blacklisting)  

**既知の攻撃パターン** を登録し、それに該当するリクエストを遮断する方式です。  

### 特徴

- OWASP ModSecurity Core Rule Set(CRS)のような**シグネチャベース**  
- SQL Injection, XSS, Command Injection などのパターンにマッチした通信を遮断  
- 既知攻撃に有効  
- 未知の攻撃には弱い(ゼロデイ攻撃には不十分)  

### 利点  

- 導入が容易  
- 誤検知が比較的少ない  

### 欠点  

- 未知攻撃/変形攻撃に弱い  
- シグネチャ更新が必要  

## フォールスネガティブ(Flase Negative)

### 定義

本来は攻撃である通信を、誤って「正常」と判定して通過させてしまうことです。  

### 発生する理由

* 未知の攻撃(ゼロデイ攻撃)  
* シグネチャ未更新  
* 攻撃手法の難読化(エンコード/分割)  
* 業務特化アプリの特殊な入力仕様  

### 影響

* 攻撃を防げない  
* 情報漏えい・改ざんが発生  
* WAF があっても侵害される  

## ホワイトリスト方式(Whitelisting)  

**許可された正規リクエストのみを通過させる方式です。**  

### 特徴

- 例：正規の URL、パラメータ形式、データ型などを定義  
- それ以外のリクエストはすべてブロック  
- 未知攻撃に強い  

### 利点  

- ゼロデイ攻撃(未知攻撃)に強い  
- アプリケーション仕様が明確であれば非常に強固  

### 欠点

- 作成/メンテナンスが大変  
- 動的サイトではルール管理が重い  
- 誤検知が発生しやすい  

## フォールスポジティブ(False Positive)

### 定義

正常な通信を、誤って「攻撃」と判断して遮断してしまうことです。  

### 発生する理由

* 厳しすぎるシグネチャ  
* 業務入力に SQL 文字列等が含まれる  
* 正常だが仕様上例外的な通信  

### 影響

* 正規ユーザのアクセス遮断  
* 業務停止・UX低下  
* 問い合わせ・運用負荷増大  

## ハイブリッド方式(Blacklist + Whitelist)

多くの商用 WAF では、下記を組み合わせて防御力を高めています。  

- ブラックリスト方式(攻撃パターン検知)  
- ホワイトリスト方式(正常動作モデル)  

## フォールスネガティブとフォールスポジティブの関係

|観点|フォールスネガティブ|フォールスポジティブ|
|:----|:----|:----|
|内容|攻撃を見逃す|正常を攻撃扱い|
|主な影響|情報漏えい|業務停止|
|原因|検知不足|過剰検知|
|セキュリティ|低下|向上（しすぎ）|
|可用性|維持|低下|

## WAF が防御可能な攻撃(Web アプリ脅威)

CSRF は WAF だけでは完全防御できず、トークン等の対策が必要です。  

| 攻撃手法 | 説明 |
|---------|------|
| SQL Injection | パラメータに悪意ある SQL を注入 |
| XSS | HTML/JS を注入しブラウザで実行 |
| Directory Traversal | `../` によるファイルアクセス |
| Command Injection | OS コマンドを実行させる |
| CSRF | 利用者を欺いて不正操作を行わせる |
| HTTP Request Smuggling | 不正に混在したリクエストを送る |
| Path Manipulation | 不正パスを用いたアクセス |

## WAF の検査方式

| 方式 | 説明 |
|------|-----|
| **シグネチャ方式** | 既知攻撃のパターンマッチ(ブラックリスト) |
| **アノマリ方式** | 正常パターンからの逸脱検知(ホワイトリスト寄り) |
| **プロトコル検査** | HTTP RFC 違反リクエストを拒否 |
| **行動モデル** | 過去の挙動との比較 |

## ネットワーク型 WAF/ホスト型 WAF

### ネットワーク型 WAF  

専用アプライアンスやクラウド型サービス(AWS WAF など)です。  

- 大規模環境向け  
- 運用が容易  
- 可視化/ログ収集が強力  

### ホスト型 WAF  

アプリケーションサーバへ直接導入(ModSecurity など)します。  

- 細かな制御が可能  
- コストが低い  
- サーバ負荷と運用が必要  

## WAF の限界

WAF だけでは防げない攻撃も多いです。  

### 防げない例  

WAF は「万能」ではなく、アプリケーション側の安全設計が必要です。  

- **ロジックフロー攻撃(業務仕様の悪用)**  
- **CSRF(アプリ側の対策必須)**  
- **認証/認可の欠陥**  
- **パスワード総当たり**  

## WAF/IPS/FW の違い

| 技術 | 防御対象 | 主なレイヤ |
|------|-----------|---------------|
| FW | IP/ポートのアクセス制御 | L3/L4 |
| IPS | ネットワーク攻撃防御(シグネチャ中心) | L3〜L7 |
| WAF | Webアプリ攻撃対策(XSS, SQLi 等) | L7 |
