# クロスサイトリクエストフォージェリ(CSRF)

## はじめに

2025年10月のプロジェクトマネージャ試験受験を終え、2026年春の情報処理安全確保支援士に向けて勉強中です。  
本記事を含めた各知識のインデックスや学習の道のりについては、「[情報処理安全確保支援士への道のり(随時更新中)](https://qiita.com/teppei19980914/items/6411cb70f2937cbefdcc)」をご参照ください。  
**本記事は学習した内容を記載しています。**  

## 該当問題

[情報処理安全確保支援士令和6年春期 午前Ⅱ 問1](https://www.sc-siken.com/kakomon/06_haru/am2_1.html)  

## 1. CSRF(Cross-Site Request Forgery)とは  

CSRF は、**ユーザが意図しないリクエストを攻撃者が強制的に送信させる攻撃です。**  

ポイント：  

- 被害者は **正規ユーザとしてログイン済み**  
- 攻撃者サイトを閲覧すると、被害者のブラウザが正規サイトへ勝手にリクエストを送る  
- Cookie が自動送信されるため、**攻撃者は認証を突破できてしまう**

例：  
- 不正送金  
- 不正なメール送信  
- 設定変更  
- ユーザアカウントの削除  

## 2. CSRF の攻撃例(基本シナリオ)

**攻撃者はログイン情報を知らなくても操作を強制できます。**  

1. ユーザが銀行サイトにログイン  
2. ユーザが攻撃者の用意したページを閲覧  
3. ページ内の hidden リクエスト(img タグなど)が銀行に対して「送金リクエスト」を発生  
4. ユーザの Cookie が自動送信される  
5. 銀行サイトは「本人の操作」と誤認し送金が成立  

## 3. CSRF が成立する条件(OWASP Root Cause)

OWASPによると、CSRF が成立する条件は以下の3つです。  

1. **被害者がログイン状態(Cookie が有効)**  
2. **攻撃者が任意のリクエストを被害者に送信させられる環境**  
3. **リクエストにユーザ操作の正当性を確認する仕組みがない**  

## 4. CSRF の対策(必須)

### ■ 1. CSRFトークン方式(最も推奨)  

- サーバがランダム値トークンを発行  
- フォームやリクエストに埋め込む  
- 攻撃者はこのトークンを推測できない  

### ■ 2. SameSite Cookie 属性  

Cookie に以下の属性を設定：  

- `SameSite=Lax`(推奨)  
- `SameSite=Strict`(最強)  
- `SameSite=None; Secure`(クロスサイト利用が必要な場合)  

SameSite は**クロスサイトのリクエストで Cookie を送らない**ように制御する仕組みで、モダンブラウザではデフォルトの防御です。  

### ■ 3. Referer/Origin チェック  

正規サイトからのリクエストかを`Origin` または `Referer` ヘッダで確認します。  

### ■ 4. 二重送信クッキー(Double Submit Cookie)  

CSRFトークンを Cookie とフォームの両方に付与し、一致を確認する方式です。  

### ■ 5. GET で状態変更を行わない(REST設計原則)

- GET = 参照のみ  
- POST/PUT/DELETE = 状態変更  

GET リクエストで設定変更できるシステムは脆弱です。  

## 5. CSRF と混同しやすい攻撃(周辺知識)

### ■ XSS(クロスサイトスクリプティング)

- **スクリプトを注入してブラウザを乗っ取る攻撃**  
- CSRF と異なり、攻撃者はユーザのブラウザ上で任意の JavaScript を実行できる  
- XSS → CSRF トークンの盗難につながることがある  

### ■ セッションフィクセーション

攻撃者が事前にセッションIDを与え、被害者の操作を乗っ取る攻撃です。  
CSRFとは独立した攻撃だが、同時に狙われやすい。  

### ■ クリックジャッキング  

透明レイヤーを重ね、ユーザを騙してクリックさせる攻撃です。  
CSRF とは異なるが、**ユーザの意図しない操作** という点で関連しています。  
